(function(a){var d=function(){_}.toString().indexOf("_")>-1,b=a.browser.msie,f=b?["toString","valueOf"]:null,e=function(){};function c(i,h,c){var e=false;if(b){var g=[];a.each(f,function(){c.hasOwnProperty(this)&&(e=true)&&g.push({name:this,val:c[this]})});if(e){a.each(c,function(a){g.push({name:a,val:this})});c=g}}a.each(c,function(c,b){if(e){c=b.name;b=b.val}if(a.isFunction(i[c])&&a.isFunction(b)&&(!d||b.toString().indexOf(".base")>-1)){var f=i[c];h[c]=function(){var a=this.base;this.base=f;var c=b.apply(this,arguments);this.base=a;return c}}else h[c]=b})}a.inherit=function(){var j=a.isArray(arguments[0]),f=j||a.isFunction(arguments[0]),g=f?j?arguments[0][0]:arguments[0]:e,k=arguments[f?1:0]||{},i=arguments[f?2:1],b=k.init||f&&g.prototype.init?function(){this.init.apply(this,arguments||[{}])}:function(){};if(!f){b.prototype=k;b.prototype.global=b.prototype.constructor=b;return a.extend(b,i)}a.extend(b,g);var l=function(){},n=g.prototype;l.prototype=g.prototype;b.prototype=new l;var d=b.prototype;d.global=d.constructor=b;c(n,d,k);i&&c(g,b,i);if(j){var p=1,o=arguments[0],m,h=[];while(m=o[p++])a.each(m.prototype,function(a){if(a=="init")h.push(this);else if(a!="global")d[a]=this});if(h.length>0){d.init&&h.push(d.init);d.init=function(){var b=0,a;while(a=h[b++])a.apply(this,arguments)}}}return b};a.fn.textWidth=function(){var b=a("<span>"+a(this).html()+"</span>");b.css("font-size",a(this).css("font-size")).hide();b.prependTo("body");var c=b.width();b.remove();return c}})(jQuery);var ui={guids:{},types:{},theme:{},emptyFn:function(){},charset:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",key:{Enter:13,Esc:27},guid:function(){for(var a=[],b=0,b=0;b<10;b++)a.push(ui.charset.charAt(Math.random()*ui.charset.length));a=a.join("");if(ui.guids[a])return ui.guid();ui.guids[a]=1;return a},selectable:function(b,c){var a=c?c:$("body");if($.browser.msie){a.unbind("selectstart");b===false&&a.bind("selectstart",function(){return false})}else if($.browser.opera){a.unbind("mousemove");b===false&&a.bind("mousemove",function(a){a.target.ownerDocument.defaultView.getSelection().removeAllRanges()})}else if(b)a.removeClass("ui-unselectable");else a.addClass("ui-unselectable")},toJson:function(a){return $.toJSON(a)},instance:function(a,c,b){b=b||ui.Base;if(a instanceof b)return a;a=ui.extend(ui.extend({},c),a);b=ui.getType(a.type);if(ui.isFunction(b))return new b(a);console.log("Undefined type "+a.type)},getBody:function(){if(!ui.body)ui.body=ui.instance({type:"element",el:"body"});return ui.body},ready:function(a,b){$(ui.delegate(a,b))},define:function(a){var c=ui.isString(a.base)?ui.getType(a.base):a.base,b=$.inherit(c||a.data,c?a.data:a.staticData,a.staticData);ui.isString(a.name)&&ui.namespace(a.name,b);ui.isString(a.type)&&ui.regType(a.type,b);return b},regType:function(a,b){this.types[a]=b},getType:function(a){return this.types[a]},toArray:function(c){for(var b=[],a=0;a<c.length;a++)b.push(c[a]);return b},clone:function(a){return $.extend(true,{},a)},extend:function(a,c,d){a=a||{};for(var b in c)if(a[b]!==undefined?d!==false:true)a[b]=c[b];return a},"namespace":function(d,c,f,e){var b=d?d.split("."):[],a=f||window;b.each(function(d,f){if(ui.isEmpty(a[d])&&e!==false)a[d]={};if(b.length-1==f&&!ui.isEmpty(c))a[d]=c;a=a[d]});return a},isArray:function(a){return a?Object.prototype.toString.call(a)==="[object Array]"||a instanceof $:false},isArrayHasElements:function(a){return ui.isArray(a)&&a.length>0},isString:function(a){return typeof a=="string"},isEmpty:function(a){return a===null||a===undefined},isNumber:function(a){return typeof a=="number"},isFunction:function(a){return typeof a=="function"},isControl:function(a){return a instanceof ui.Control},each:function(b,d,c){var a,e;c=c||b;if(ui.isArray(b)){for(a=0,e=b.length;a<e;a++)if(d.call(c,b[a],a)===false)return}else if(b)for(a in b)if(d.call(c,b[a],a)===false)return},delegate:function(c,b,a){a=ui.isEmpty(a)?ui.toArray(arguments):a;return function(){return ui.isArray(a)?c.apply(b,a):c.call(b,a)}},contains:function(b,c){var a=b.length;while(a--)if(b[a]===c)return a;return false}};ui.ns=ui.namespace;ui.extend(Array.prototype,{contains:function(b){var a=this.length;while(a--)if(this[a]===b)return a;return false},remove:function(b){var a=this.length;while(a--)if(this[a]===b){this.splice(a,1);return a}},each:function(c,b){b=b||this;for(var a=0,d=this.length;a<d;a++)if(c.call(b,this[a],a)===false)return}},false);ui.extend(Function.prototype,{delegate:function(b,a){var c=this;a=ui.isEmpty(a)?ui.toArray(arguments):a;return function(){return ui.isArray(a)?c.apply(b,a):c.call(b,a)}},defer:function(c,a,b){setTimeout(this.delegate(a,b),c)}});ui.global={jqueryEvents:["click","mouseup","mousemove","mousedown","mouseenter","mouseleave","mousewheel","focus","blur","keyup","keypress","scroll","load","dblclick"],jqueryMethods:["attr","offset","animate","stop","append","before","empty","css","find","click","addClass","removeClass","hasClass","outerWidth","outerHeight","scrollLeft","scrollTop"]};ui.define({name:"ui.Base",type:"base",data:{destroyed:null,init:function(a){ui.extend(this,a);this.initEvents();this.initPlugins()},initPlugins:function(){this._plugins={};ui.each(this.plugins,function(a,c){var b=ui.instance(ui.isString(a)?{type:a}:a,{component:this});this.on("destroy",b.destroy,b);this._plugins[a.name||c]=b},this);delete this.plugins},getPlugin:function(a){return this._plugins[a]},initEvents:function(){this.events={};ui.each(this.listeners,function(a,b){if(b==="scope")return;if(ui.isFunction(a))this.on(b,a,this.listeners.scope||this);else this.on(b,a.fn,a.scope||this.listeners.scope)},this);delete this.listeners},on:function(a,d,c){if(!this.events)this.events=[];if(!this.events[a])this.events[a]=[];var b={fn:d,scope:c||this,id:ui.guid()};this.events[a].push(b);return b},un:function(a,c){var b=this.events;if(ui.isEmpty(b))return;if(ui.isString(a))if(c)this.events[a].remove(c);else delete this.events[a];else ui.each(b,function(d,c){ui.each(b[c],function(b){b.scope===a&&this.events[c].remove(b)},this)},this)},fire:function(a,e){if(!this.events||!this.events[a]||!this.events[a].length)return;for(var d,c=this.events[a].length-1;c>=0;c--){var b=this.events[a][c];if(b)d=ui.delegate(b.fn,b.scope,e)()}return d},destroy:function(){this.fire("destroy",this);for(var a in this)delete this[a];this.destroyed=true}}});ui.define({name:"ui.core.EventsManager",base:"base",data:{init:function(){this.base();this.initResize();var a=this;ui.global.jqueryEvents.each(function(b){$(document).bind(b,function(c){a.fire(b,c)})})},initResize:function(){var c=new Date(1,1,2e3),a=false,b=200,d=function(){if(new Date-c<b)setTimeout(d,b);else{a=false;this.fire("resizeEnd")}}.delegate(this);$(window).resize(function(){c=new Date;if(a===false){a=true;setTimeout(d,b)}})},on:function(c,d,a){var b=this.base(c,d,a);if(a instanceof ui.Base)a.on("destroy",function(){this.un(c,b)},this);return b}}});ui.EventsManager=new ui.core.EventsManager;ui.define({name:"ui.core.DragAndDropManager",base:"base",data:{dragControl:null,dropControl:null,groups:{},add:function(a){a.on("mousedown",function(e,d){ui.selectable(false);a.fire("dragStart",[d,a]);var b=ui.EventsManager.on("mousemove",function(b){a.fire("drag",[b,a])}),c=ui.EventsManager.on("mouseup",function(d){a.fire("drop",[d,a]);ui.selectable(true);ui.EventsManager.un("mousemove",b);ui.EventsManager.un("mouseup",c)})})},addDraggable:function(c,a){var b=c.getDragZone();if(ui.isEmpty(a))a=["all"];else if(ui.isString(a))a=[a];if(b)b.on("mousedown",function(d,b){this.onDragStart(c,a,b)},this)},addDropZone:function(b,a){var c=b.getDropZone(a);if(ui.isEmpty(a))a="all";if(!this.groups[a])this.groups[a]=[];this.groups[a].push(b);b.on("destroy",function(){this.groups[a].remove(b)},this);c.on("mouseenter",function(){this.dropControl=b;b.currentZone=a;this.dragControl&&c.addClass("ui-zone-has-drop")},this);c.on("mouseleave",function(){if(this.dropControl){this.dropControl.removeClass("ui-hover");this.dropControl.removeClass("ui-right-drop");this.dropControl.removeClass("ui-left-drop")}this.dropControl=null;b.currentZone=null;c.removeClass("ui-zone-has-drop")},this)},onDragStart:function(b,f,d){var c=this.getControls(f),a=$('<div style="position:absolute;z-index:99999" />').append(b.createDragElement(d)).css({left:d.clientX+$(window).scrollLeft(),top:d.clientY+$(window).scrollTop()});this.dragControl=b;var g=ui.EventsManager.on("mousemove",function(d){if(a.parent().length==0){a.appendTo("body");c.each(function(a){a.addClass("ui-has-drop")});ui.selectable(false)}a.css({left:d.clientX+5,top:d.clientY+5});var b=this.dropControl;if(b){b.removeClass("ui-left-drop");b.removeClass("ui-right-drop");b.addClass(b.el.outerWidth()/2>d.layerX?"ui-left-drop":"ui-right-drop");b.addClass("ui-hover")}},this),e=ui.EventsManager.on("mouseup",function(i){if(this.dropControl&&c.contains(this.dropControl)!==false&&this.dropControl!==this.dragControl){var d=this.dropControl,h=d.hasClass("ui-right-drop")?"after":"before";d.fire("drop",[b,i,h,d.currentZone]);b.fire("dragdrop",[d,i,h,d.currentZone]);a.remove()}else{var f=b.getDragZone().offset();a.animate({left:f.left,top:f.top},function(){a.remove()})}ui.selectable(true);this.dragControl=null;c.each(function(a){a.removeClass("ui-has-drop")});ui.EventsManager.un("mousemove",g);ui.EventsManager.un("mouseup",e)},this)},getControls:function(b){var a=[];b.each(function(b){if(this.groups[b])a=a.concat(this.groups[b])},this);return a}}});ui.DragAndDropManager=new ui.core.DragAndDropManager;ui.define({name:"ui.core.HashWatcher",base:"base",data:{watchTime:100,lastHash:false,lastFullHash:false,init:function(){this.base();this.watch()},getHash:function(b){var c=window.location.hash.split("#"),a=c[1];if(ui.isEmpty(a))return"";if(b!==true)a=this.splitHash(a)[0];return a},splitHash:function(a){var b=a.indexOf("?"),d=a,c="";if(b>0){d=a.substring(0,b);c=a.substring(b+1)}return[d,c]},setHash:function(a,b){try{if(b===true){this.lastFullHash=a;this.lastHash=this.splitHash(a)[0]}window.location.hash=a}catch(c){console.log(c)}},watch:function(){var b=this.getHash(),a=this.getHash(true);if(b!==this.lastHash){this.lastHash=b;this.fire("change",b)}if(a!==this.lastFullHash){this.lastFullHash=a;this.fire("changeParams",[a,this.getHashParams()])}this.watch.defer(this.watchTime,this)},getHashParams:function(){var a={},c=/([^\?\#\&]+)\=([^\?\#\&]+)/ig,b=this.getHash(true);if(!b)return a;b.replace(c,function(d,c,b){a[c]=b});return a}}});ui.HashWatcher=new ui.core.HashWatcher;ui.define({name:"ui.Array",type:"array",base:"base",data:{init:function(a){this.list=a||[];this.base()},add:function(a,b){if(ui.isEmpty(b))this.list.push(a);else this.list.splice(b,0,a);this.fire("add",[a,this]);this.fire("update");return a},remove:function(b){var a=this.list.length;while(a--)if(this.list[a]===b){this.list.splice(a,1);this.fire("remove",[b,this]);this.fire("update");return}},contains:function(a){return ui.contains(this.list,a)},each:function(a,b){ui.each(this.list,a,b||this)},groupBy:function(a,c){var b=[],e=ui.array(c).findOne({code:a}),d={};if(ui.isArray(a)){var f=this.groupBy(a[0],c);a.shift();this.groupByArray(a,f,c);return f}this.each(function(f){var e=f[a]||"",c=d[e];if(!c){c={group:e,code:a,items:[]};b.push(c);d[e]=c}c.items.push(f)});delete d;if(e){b.sort(function(c,d){var a=c.group.toLowerCase(),b=d.group.toLowerCase();return a>b?1:a<b?-1:0});e.dir=="DESC"&&b.reverse()}return b},groupByArray:function(a,c,b){if(a.length==0)return;var d=a[0];a.shift();ui.each(c,function(c){c.items=ui.array(c.items).groupBy(d,b);this.groupByArray(a.slice(0),c.items,b)},this)},map:function(a){var c=[],b=a;if(ui.isString(a))b=function(b){return b[a]};this.each(function(a){c.push(b(a))});return c},queryFn:function(d,c){var b=true;for(var a in c){if(c[a]instanceof Array)b=c[a].contains(d[a])!==false;else if(c[a]!=="")b=d[a]==c[a];else b=d[a]===null||d[a]===undefined;if(!b)return b}return b},find:function(a,b,e){var f=this,c=[],g=this.list,d=ui.isFunction(a)?a:f.queryFn;this.each(function(f){if(f!==undefined&&f!==null&&d(f,a)){c.push(f);if(b)return b.apply(e,[f])}},this);return c},findOne:function(b){var a=null;this.find(b,function(b){a=b;return false});return a},findAndGroup:function(b,a){var c=ui.array(this.find(b));return c.groupBy(a)},"get":function(a){return this.list[a]},getGroups:function(b){var a=[];this.each(function(c){a.contains(c[b])===false&&a.push(c[b])});return a}}});ui.array=function(a){return new ui.Array(a)};ui.define({name:"ui.Element",type:"element",base:"base",data:{tag:"div",cls:null,autoRender:true,html:null,parent:null,style:null,width:null,minWidth:null,maxWidth:null,height:null,minHeight:null,maxHeight:null,fit:false,hidden:false,rendered:false,el:null,init:function(a){a=a||{};this.base(a);if(a.el){this.rendered=true;this.parent=$(a.el).parent();this.initJqueryEvents()}this.el=$(a.el?a.el:"<"+this.tag+"/>");this.hidden&&this.hide();this.autoRender!==false&&this.parent&&this.doRender()},doRender:function(){if(!this.rendered){this.setParent(this.parent);this.fire("renderStart",this);this.render();this.rendered=true;this.setWidth(this.width);this.setHeight(this.height);this.el.appendTo(this.parent);this.fire("renderEnd",this)}else this.checkParent()&&this.el.appendTo(this.parent)},checkParent:function(){var b=this.el.parent().length>0?this.el.parent()[0]:this.el.parent(),a=this.parent&&this.parent.length>0?this.parent[0]:this.parent;return b!==a},render:function(){this.domAttributes&&ui.each(this.domAttributes,function(b,a){this.attr(a,b)},this);this.addClass(this.cls);this.extraCls&&this.addClass(this.extraCls);!ui.isEmpty(this.html)&&this.setHtml(this.html);this.style&&this.css(this.style);this.fit&&this.addClass("ui-fit");this.setTop(this.top);this.setBottom(this.bottom);this.setLeft(this.left);this.setRight(this.right);this.initJqueryEvents()},setParent:function(a){if(!a)return;if(ui.isString(a))a=$(a);else if(ui.isControl(a)){a.doRender();a=a.getBody().el}else if(a instanceof ui.Element)a=a.el;this.parent=a},setHtml:function(a){this.el.html(a)},getHtml:function(){return this.el.html()},getDom:function(){return this.rendered?this.el[0]:null},hasDom:function(b){if(this.getDom()===b)return true;var a=false,c=ui.toArray(this.find("*"));c.each(function(c){if(c===b){a=true;return false}});return a},setWidth:function(a){if(!this.el)return;if(!ui.isString(a)){if(this.minWidth!==null&&a<this.minWidth)a=this.minWidth;if(this.maxWidth!==null&&a>this.maxWidth)a=this.maxWidth}this.el.width(a)},setHeight:function(a){if(!this.el)return;if(!ui.isString(a)){if(this.minHeight!==null&&a<this.minHeight)a=this.minHeight;if(this.maxHeight!==null&&a>this.maxHeight)a=this.maxHeight}this.el.height(a)},setTop:function(a){!ui.isEmpty(a)&&this.css({position:"absolute",top:a})},setBottom:function(a){!ui.isEmpty(a)&&this.css({position:"absolute",bottom:a})},setLeft:function(a){!ui.isEmpty(a)&&this.css({position:"absolute",left:a})},setRight:function(a){!ui.isEmpty(a)&&this.css({position:"absolute",right:a})},show:function(){this.doRender();this.el.show();this.fire("show",this)},hide:function(){this.el.hide();this.fire("hide",this)},toggle:function(){if(this.el.css("display")=="none")this.show();else this.hide()},appendTo:function(a){this.setParent(a);this.doRender();this.fire("domUpdate",this)},setActive:function(a){var b=this.cls+"-active";if(a===true)this.addClass(b);else this.removeClass(b);this.active=a},destroy:function(){this.el&&this.el.remove();this.base()},initJqueryEvents:function(){var b=this.jqueryEvents||ui.global.jqueryEvents,a=this;b.each(function(b){this.el.bind(b,function(){var c=[a].concat(ui.toArray(arguments));a.fire(b,c)})},this)}}});ui.each(ui.global.jqueryMethods,function(a){var b=a;if(ui.isString(a))b={name:a,jName:a};ui.Element.prototype[b.name]=function(){if(!this.el)return;var a=this.el[b.jName].apply(this.el,arguments);this.fire&&this.fire(b.name,this);return a}});ui.define({name:"ui.Control",type:"control",base:"element",data:{viewType:"view",cls:"control",disabled:false,readOnly:false,init:function(a){a=a||{};ui.extend(a,{id:ui.guid(),controls:[]});this.base(a)},render:function(){this.base();this.renderView();ui.each(this.items,function(a){this.add(a)},this);this.setDisabled(this.disabled);this.setReadOnly(this.readOnly);this.dropZone&&ui.DragAndDropManager.addDropZone(this,this.dropZone);this.dropZones&&ui.DragAndDropManager.addDraggable(this,this.dropZones)},removeAllControls:function(){var a=this.controls.length-1;while(a>=0){this.controls[a].destroy();a--}},renderView:function(){if(ui.isString(this.viewType))this.viewType=ui.getType(this.viewType);this.view=new this.viewType(this)},viewUpdate:function(){this.view instanceof ui.ControlView&&this.view.update()},getBody:function(){return this.view?this.view.getBody():null},createDragElement:function(){return this.view.createDragElement()},getDragZone:function(){return this.view.getDragZone()},getDropZone:function(){return this.view.getDropZone()},setDisabled:function(a){this.view.setDisabled(a);this.disabled=a},setReadOnly:function(a){this.view.setReadOnly(a);this.readOnly=a},setIcon:function(a){this.iconCls=a;this.view.setIcon(a)},setLabel:function(a,b){this.view.setLabel(a,b)},setLabelPosition:function(a){this.view.setLabelPosition(a)},setHtml:function(b){var a=this.getBody();if(a instanceof ui.Element)a.setHtml(b);else a.html(b)},add:function(b,c,d){var a;c=c||this.getBody();b=b||{};if(ui.isString(b)){if(b=="clear")a=ui.instance({type:b});else if(b=="-")a=ui.instance({type:"seporater"})}else a=ui.instance(b,this.defaults,ui.Element);if(a){a.owner=this;this.buildReference(b.ref,a);this.bindEditableData(a);this.controls.push(a);this.fire("addControl",a);a.on("destroy",function(){this.controls.remove(a)},this);if(d!==false&&a.autoRender!==false)a.appendTo(c);else a.setParent(c)}return a},remove:function(a){if(ui.isControl(a)){this.controls.remove(a);a.destroy()}},destroy:function(){if(this.rendered){if(this.forceDestroyChildren===true){for(var b=this.controls.length,a=b-1;a>=0;a--){this.controls[a].forceDestroyChildren=true;this.controls[a].destroy()}this.controls.splice(0,this.controls.length)}this.view.destroy()}this.base()}}});ui.define({name:"ui.ControlView",type:"view",base:"base",data:{labelPositions:["left","right","top","bottom"],defaultLabelPosition:"right",disabled:false,readOnly:false,active:false,init:function(a){this.base({boxes:{},control:a,parent:a.el,cls:a.cls});this.viewConfig().each(function(a){this.setBox(a,this.control)},this);a.on("update",this.update,this);ui.EventsManager.on("resizeEnd",this.update,this)},viewConfig:function(){return[]},update:function(){this.fire("viewUpdate")},setDisabled:function(a){var b=this.cls+"-disabled";this.disabled=a;if(a===true)this.parent.addClass(b);else this.parent.removeClass(b)},setReadOnly:function(a){this.readOnly=a},setBox:function(a,c,b){if(ui.isString(c)){b=c;c=this.getBox(c)}var d=ui.isString(a)?a:a.name,b=b?b+"."+d:d,f={name:d,parent:c?c.el:this.parent,cls:this.cls?this.cls+"-"+d:d,type:"element"};if(!ui.isString(a)){if(a.listeners)a.listeners.scope=a.listeners.scope||this;f=ui.extend(f,a)}var e=ui.instance(f);this.boxes[b]=e;ui.each(e.items,function(a){this.setBox(a,b,ui.isString(b)?b:b.name)},this);return e},getBox:function(b,e,a){var d=ui.isString(b)?b:b.name,f=a?a+"."+d:d,c=this.boxes[f];if(!c&&e===true){var g=a?this.getBox(a):null;c=this.setBox(b,g,a)}return c},removeBox:function(a){var b=ui.isString(a)?this.getBox(a):a;if(b){b.destroy();delete this.boxes[a]}},getBody:function(){return this.parent},getDragZone:function(){return this.getBody()},getDropZone:function(){return this.getBody()},createDragElement:function(){return this.type},setLabel:function(a,b){if(a){this.setLabelPosition(b);var c=this.getBox("label",true);c.setHtml(a)}else{this.removeBox("label");this.setLabelPosition(b)}},setLabelPosition:function(a){var b=this.labelPositions,a=a||this.defaultLabelPosition;b.each(function(a){this.parent.removeClass(this.cls+"-"+a)},this);this.parent.addClass(this.cls+"-"+a)}}});ui.define({name:"ui.Clear",type:"clear",base:"element",data:{cls:"ui-clear"}});ui.define({name:"ui.QueryBuilderView",type:"queryBuilder.view",base:"view",data:{init:function(a){this._groups={};this.base(a)},viewConfig:function(){return["body","menu"]},getField:function(b){var a=this.control,e=this,d=a.getFieldTitle?a.getFieldTitle(b.field):b.field,c=$('<span class="field">'+d+"</span>");return c.click(function(){var d=[];a.getFields().each(function(c){d.push({text:a.getFieldTitle?a.getFieldTitle(c):c,handler:function(){b.field=c;a.redraw()}})});e.showMenu(c,d,true)})},getValue:function(a){var d=this.control,b=this,c=$('<span class="value">'+a.value+"</span>");return c.click(function(i){if(i.target!==c.get(0))return;var e=$('<input type="text"/>').val(a.value),g=function(){a.value=e.val();d.redraw()},f=function(){var f=[],g=d.getField(a.field);if(g&&g.area=="data")return false;b.getGroups(a.field,e.val(),function(b){f.push({text:b,handler:function(){a.value=b;d.redraw()}})});if(f.length)b.showMenu(c,f,false);else b.getBox("menu").hide()};e.bind("keyup",function(a){if(a.keyCode==ui.key.Enter)g();else if(a.keyCode==ui.key.Esc){e.remove();b.getBox("menu").hide()}else f()});e.appendTo(c).focus();f();var h=ui.EventsManager.on("mouseup",function(a){if(a.target!==e.get(0)&&a.target!==c.get(0)&&!b.getBox("menu").hasDom(a.target)){ui.EventsManager.un("mouseup",h);g()}b.getBox("menu").hasDom(a.target)&&ui.EventsManager.un("mouseup",h)})})},getGroups:function(c,d,a){var b=function(a){return a.toString().toLowerCase().indexOf(d.toString().toLowerCase())>=0};this.control.getGroups(c,function(c){ui.array(c).find(b,a)})},getCondition:function(f,b){var a=this.control,c=a.operands,e=this,d=$('<span class="cnd">'+f+"</span>");return d.click(function(){var f=[],g=a.getOperands?a.getOperands(b.field):e.defaultOperands;g.each(function(d){f.push({text:c[d].view,icon:c[d].icon,handler:function(){b.op=d;a.redraw()}})});e.showMenu(d,f,true)})},getOperand:function(b,a,d){var c=this.control,h=this,g=c.operands,e=$('<span class="operand">['+g[b].view+"]</span>"),f=function(){delete a[b];d&&!a.AND&&!a.OR&&d.remove(a);c.redraw()};d&&$('<div class="ui-close"/>').click(f).appendTo(e);return e.click(function(){var i=[{text:g[b=="AND"?"OR":"AND"].view,handler:function(){a[b=="AND"?"OR":"AND"]=a[b];delete a[b];c.redraw()}},"-",{text:'Добавить "И"',handler:function(){a[b].push({AND:[]});c.redraw()}},{text:'Добавить "ИЛИ"',handler:function(){a[b].push({OR:[]});c.redraw()}},{text:"Добавить условие",handler:function(){a[b].push({field:c.getFields()[0],value:"",op:"EQ"});c.redraw()}}];if(d){i.push("-");i.push({text:"Удалить",handler:f})}h.showMenu(e,i,true)})},showMenu:function(b,d,c){var a=this.getBox("menu");if(c!==false)ui.EventsManager.on("mouseup",function(c){if(a.hasDom(c.target)===false&&b.get(0)!==c.target&&a.css("display")!="none"){a.hide();ui.EventsManager.un(a)}});a.appendTo(b);a.empty();a.show();d.each(function(b){if(b=="-")a.append('<div class="sep"></div>');else a.append($('<div class="item"><span>'+(b.icon||"")+"</span>"+b.text+"</div>").click(function(){b.handler();a.hide()}))})}}});ui.define({name:"ui.QueryBuilder",type:"queryBuilder",base:"control",data:{cls:"ui-qbldr",viewType:"queryBuilder.view",regexField:/\[([A-Za-zА-Яа-я0-9_]+)\]/g,regexOR:/OR/g,regexAND:/AND/g,defaultOperands:["EQ","NOT","LT","LTR","GT","GTR"],operands:{EQ:{js:"==",icon:"=",html:"=",view:"равно"},NOT:{js:"!=",icon:"!=",html:"!=",view:"не равно"},GT:{js:">",icon:"&gt;",html:"&gt;",view:"больше"},GTR:{js:">=",icon:"&gt;=",html:"&gt;=",view:"больше или равно"},LT:{js:"<",icon:"&lt;",html:"&lt;",view:"меньше"},LTR:{js:"<=",icon:"&lt;=",html:"&lt;=",view:"меньше или равно"},AND:{js:"AND",html:'<span style="color:red">и</span>',view:"и"},OR:{js:"OR",html:'<span style="color:red">или</span>',view:"или"}},render:function(){this.base();this.redraw()},redraw:function(){this.renderQueryTree();this.find(".group > .condition:last-child, .group > .group:last-child").addClass("last");this.fire("redraw")},renderQueryTree:function(){var c=this.view,i=this,f=this.view.getBox("body"),d=this.query,e=d.AND,g=d.OR,h=this.operands,b=$('<div class="group"><div class="elbow"/></div>'),a=function(d,l,k,g,f){var j=c.getOperand(l,g,f),e=[j,'<div class="ui-clear"/>'];ui.each(d,function(f){var k=f.AND,l=f.OR,j=b.clone();if(k){e.push(j);a(k,"AND",j,f,d)}else if(l){e.push(j);a(l,"OR",j,f,d)}else if(f.field){var g=$('<div class="condition"><div class="elbow"/></div>');g.append(c.getField(f,d));g.append(c.getCondition(h[f.op].view,f));g.append(c.getValue(f,d));g.append($('<div class="ui-close"/>').click(function(){d.remove(f);i.redraw()}));g.append('<div class="ui-clear"/>');e.push(g)}},this);e.each(function(a){$(a).appendTo(k)})};e&&a(e,"AND",b,d,null);g&&a(g,"OR",b,d,null);f.empty();b.appendTo(f.el)},getQueryFunction:function(){var queryFunction=null,code=this.getJavaScriptQuery();try{eval("queryFunction=function(r){return("+code+")};")}catch(e){return null}return queryFunction},getJavaScriptQuery:function(){return this.getQueryString("js").replace(this.regexField,function(b,a){return"r['"+a+"']"}).replace(this.regexOR,"||").replace(this.regexAND,"&&")},_groupToString:function(c,f,a){var b=[],d="",e="";if(c&&c.length>1){d=" ( ";e=" ) "}ui.each(c,function(c){var d=c.AND,e=c.OR;if(d&&d.length)b.push(this._groupToString(d,"AND",a));else if(e&&e.length)b.push(this._groupToString(e,"OR",a));else c.field&&b.push(this._criteriaToString(c,a))},this);return d+b.join(" "+this.operands[f][a]+" ")+e},_criteriaToString:function(d,b){var a=[],c=d.field;if(b=="html"&&this.getFieldTitle)c=this.getFieldTitle(c);a.push("[");a.push(c);a.push("]");a.push(" ");a.push(this.operands[d.op][b]);a.push(b=="view"||b=="html"?"  ":" '");a.push(d.value);a.push(b=="view"||b=="html"?" ":"'");return a.join("")},getQueryString:function(a){var e=this.query,b=e.AND,c=e.OR,d=[];a=a||"view";b&&b.length&&d.push(this._groupToString(b,"AND",a));c&&c.length&&d.push(this._groupToString(c,"OR",a));return d.join(" AND ")}}});ui.define({name:"ui.form.FieldView",type:"field.view",base:"view",data:{defaultTriggerIcon:"",defaultTag:"input",defaultAttributes:{autocomplete:"off"},init:function(a){this.tag=a.fieldTag||this.defaultTag;this.domAttributes=ui.extend(a.fieldAttributes||this.defaultAttributes,{name:a.fieldName,type:a.password?"password":"text"});this.base(a)},viewConfig:function(){return[{name:"input",listeners:{click:this.onClick},items:[{name:"el",tag:this.tag,domAttributes:this.domAttributes,listeners:{focus:this.onFocus,blur:this.onBlur,keyup:this.onKeyUp,keypress:this.onKeyPress}}]}]},setReadOnly:function(a){this.base(a);this.getBox("input.el").attr("readonly",a)},setLabel:function(a){if(a){this.getBox("label",true).setHtml(a);this.control.addClass("has-label")}else{this.removeBox("label");this.control.removeClass("has-label")}},setDisabled:function(a){this.base(a);this.getBox("input.el").attr("disabled",a)},setValue:function(a){this.getBox("input.el").el.val(a)},getValue:function(){return this.getBox("input.el").el.val()},onClick:function(){this.disabled!==true&&this.fire("click")},onKeyUp:function(a,b){this.readOnly!==true&&this.fire("keyup",[a,b])},onKeyPress:function(a,b){this.readOnly!==true&&this.fire("keypress",[a,b])},focus:function(){this.getBox("input.el").focus()},blur:function(){this.getBox("input.el").blur()},onFocus:function(a,b){this.fire("focus",[a,b]);this.parent.addClass(this.cls+"-focus")},onBlur:function(a,b){this.parent.removeClass(this.cls+"-focus");this.fire("blur",[a,b])},updateTriggers:function(){var b=this.getBox("triggers"),a=0;if(b)a=b.outerWidth();this.getBox("input.el").setRight(a)},addTrigger:function(a){var b=function(b,c){ui.isFunction(a.handler)&&a.handler.delegate(a.scope,[b,c])();this.fire("triggerClick",[a.name,b,c])},c=this.getBox("triggers",true);this.setBox({items:[{name:"trigger-icon",cls:this.cls+"-trigger-icon "+(a.iconCls||this.defaultTriggerIcon)}],name:a.name,cls:this.cls+"-trigger",style:a.style,domAttributes:a.domAttributes,listeners:{click:b}},c,a.name);this.updateTriggers()},setIcon:function(a){this.parent.removeClass(this.cls+"-has-icon");this.removeBox("icon");if(a){var b=this.getBox("icon",true);this.parent.addClass(this.cls+"-has-icon");b.addClass(a)}}}});ui.define({name:"ui.form.Field",type:"field",base:"control",data:{viewType:"field.view",cls:"ui-field",changeOnEnter:true,triggers:null,displayName:null,dataIndex:null,render:function(){this.base();this.view.on("blur",this.onBlur,this);this.view.on("keypress",this.onKeyPress,this);this.view.on("keyup",this.onKeyUp,this);this.setIcon(this.iconCls);this.setLabel(this.label);ui.each(this.triggers,this.addTrigger,this);this.view.setValue(this.getRawValue(this.value))},setFocus:function(){this.view.focus()},clearFocus:function(){this.view.blur()},addTrigger:function(a){a=ui.extend(a||{},{handler:ui.emptyFn,scope:this,name:"trigger"},false);this.view.addTrigger(a)},onBlur:function(a){this.fire("blur");this.onChange(a)},onChange:function(){var a=this.view.getBox("input.el").el.val();this.setValue(a==""?null:a)},onKeyPress:function(a,b){this.fire("keyPress",[a,b])},onKeyUp:function(a,b){if(this.changeOnEnter&&b.keyCode==ui.key.Enter)this.onChange(a);this.fire("keyUp",[a,b])},setValue:function(a,b){if(ui.isEmpty(a))a=undefined;if(this.checkValue(a)){this.value=a;this.view.setValue(this.getRawValue(this.value));b!==true&&this.fire("change",[this.getValue(),this])}},checkValue:function(a){return ui.isString(a)?a!==this.getRawValue(this.value):this.value!==a},getValue:function(){return this.dataIndex&&this.value?this.value[this.dataIndex]:this.value},getRawValue:function(a){if(ui.isString(a)||ui.isEmpty(a))return a;var b=this.displayName?a[this.displayName]:a;return ui.isString(b)?b:ui.toJson(b)}}});ui.define({name:"ui.form.ComboBox",type:"combo",base:"field",data:{autoClose:true,readOnly:true,valueRenderer:null,closed:null,cls:"ui-combo",init:function(a){ui.extend(a,{closed:true,dataLoaded:false});a.triggers=(a.triggers||[]).concat({iconCls:"icon_combo_open",handler:this.toggle,scope:this});this.base(a)},render:function(){this.base();this.view.on("click",function(){this.readOnly&&this.toggle()},this);this.container=ui.instance({type:"element",parent:"body",cls:this.cls+"-box",autoRender:false});if(this.autoClose)ui.EventsManager.on("mousedown",this.onDocumentClick,this)},open:function(){this.fire("beforeOpen");if(!ui.isArrayHasElements(this.data))return;this.container.show();var a=this.offset(),b=this.el.outerHeight(),c=this.el.outerWidth();this.container.css({top:b+a.top,width:c,left:a.left});this.closed=false;if(!this.dataLoaded){ui.each(this.data,this.addValue,this);this.dataLoaded=true}},addValue:function(b){var a=ui.instance({type:"element",parent:this.container});if(ui.isFunction(this.valueRenderer))this.valueRenderer(a,b);else{a.setHtml(this.displayName?b[this.displayName]:b);a.addClass("ui-combo-value")}a.on("click",function(){this.close();this.setValue(b)},this);this.on("change",function(c){if(c===b)a.addClass("active");else a.removeClass("active")},this);this.value===b&&a.addClass("active");return a},close:function(){this.fire("beforeClose");if(this.container){this.container.hide();this.closed=true}},toggle:function(){if(this.closed)this.open();else this.close()},onDocumentClick:function(a){!this.hasDom(a.target)&&!this.container.hasDom(a.target)&&this.close()},setValue:function(a,b){this.dataIndex&&ui.each(this.data,function(b){if(b[this.dataIndex]===a){a=b;return false}},this);this.base(a,b)},hasDom:function(a){return this.base(a)||this.container.hasDom(a)},destroy:function(){this.container&&this.container.destroy();this.base()}}});ui.define({name:"ui.olap.Layout",type:"olap.Layout",base:"base",data:{areas:["filter","data","rows","columns"],sorts:["ASC","DESC"],init:function(a){this.base(a)},update:function(a){var b=this.olap,d=b.fields,c=ui.array(a.f),e=this.areas,f=this.sorts;a=a||this.data;this.data=a;this._eg=a.e||[];d.each(function(a){var b=c.findOne({c:a.dataIndex});if(b){a.filter=b.f;a.sort=b.s>=0?f[b.s]:null;a.area=b.a>=0?e[b.a]:"filter";a.width=b.w}else{delete a.filter;delete a.sort;delete a.width;a.area="filter"}});b.on("redraw",function(){this._eg.reverse();ui.each(this._eg,this.expandNodeByPath,this);b.view.updateSize();b.dataScroll()},this);this.fire("update",[a]);b.filter.defer(1,b)},expandNodeByPath:function(e){var c=this.olap,d=c.rootColumns.concat(c.rootRows),b=false,a=null;ui.each(e.split("::"),function(e){var c=e.split(":"),f=c[0],g=c[1];ui.each(a?a.groups:d,function(c){if(c.field.code==f&&c.title==g){b=true;a=c;return false}});if(!a){b=false;return false}});if(b)if(!a.parentGroup)a.expand(true,true);else var f=a.parentGroup.on("silent_expand",function(b){if(b){a.parentGroup.un("silent_expand",f);a.expand(true,true)}})},getLayout:function(){var b=this.olap,a={f:[],e:this._eg};b.fields.each(function(b){var c={c:b.dataIndex,a:this.areas.contains(b.area)};if(b.width)c.w=b.width;if(b.sort)c.s=this.sorts.contains(b.sort.toUpperCase());if(b.filter&&b.filter.length)c.f=b.filter;a.f.push(c)},this);this.fire("get",a);return a},clear:function(){var a=this.olap;this._eg=[];a.fields=[];a.defaultFields.each(function(b){a.fields.push(ui.clone(b))});this.fire("clear");a.filter()},restore:function(){var a=this.olap.defaultLayout;if(a)this.setLayout(a);else this.clear()},setLayout:function(a){if(ui.isString(a)){var b=this.getLayouts();a=b[a]}if(a){this.update(a);return true}return false},removeLayout:function(b){var a=this.getLayouts(),c=this.getKey();delete a[b];localStorage&&localStorage.setItem(c,JSON.stringify(a))},getKey:function(){return"olap."+this.olap.stateId+".layouts"},save:function(c){var d="olap."+this.olap.stateId+".layouts",b=this.getLayout(),a=this.getLayouts();a[c]=b;localStorage&&localStorage.setItem(d,JSON.stringify(a))},getLayouts:function(){if(localStorage){var a=localStorage.getItem("olap."+this.olap.stateId+".layouts");return a?JSON.parse(a):{}}return{}},onGroupExpand:function(a,c){if(a.summary||a.mainColumnSummary)return;var b=a.getPath();if(!this._eg)this._eg=[];if(c)this._eg.contains(b)===false&&this._eg.push(b);else this._eg.remove(b);this._eg.sort()}}});ui.define({name:"ui.olap.GroupView",type:"olapGroupView",base:"view",data:{viewConfig:function(){return[{name:"title",items:[{tag:"span",name:"span"},"expand",{name:"resize",listeners:{scope:this.control,drop:this.control.onResizeEnd,drag:this.control.onResize}}]}]},getBody:function(){return this.control}}});ui.define({name:"ui.olap.Group",type:"olapGroup",base:"control",data:{olap:null,viewType:"olapGroupView",cls:"group",init:function(a){this.groups=[];this.expanded=true;this.base(a);this.on("expand",function(a){this.olap.layout.onGroupExpand(this,a)},this)},render:function(){this.base();if(this.olap.selection)this.view.getBox("title.span").on("click",function(c,b){var a;if(b.ctrlKey)a="merge";if(b.shiftKey)a="range";this.select(false,a)},this);this.view.getBox("title.span").setHtml(this.title||"Пусто");this.view.getBox("title.expand").on("click",this.toggle,this);if(this.field){this.dataField=this.olap.fields.findOne({dataIndex:this.field.code||this.field.dataIndex});this.field.summary&&this.single()}},getPath:function(){var a=this,b=[];while(a){b.push(a.field.code+":"+a.title);a=a.parentGroup}b.reverse();return b.join("::")},getFullName:function(c){var a=this,b=[];while(a){b.push(a.getName());a=a.parentGroup}b.reverse();return b.join(c||" ")},getName:function(){var a=this.title;if(this.isSummary())a=this.parentGroup?this.parentGroup.title:null;a=a||"Пусто";return a.replace(/<\/?[^>]+(>|$)/g,"")},lastGroup:function(){var a=this.sumGroup?this.sumGroup:this.groups[this.groups.length-1];if(this.expanded&&this.olap.hideSummary)a=this.groups[this.groups.length-2];return a||this.groups[this.groups.length-1]},single:function(){this.view.removeBox("title.expand");this.addClass("single")},toggle:function(){this.expand(!this.expanded)},isSummary:function(){return this.summary||this.field&&this.field.summary},isExpandable:function(){var a=this.parentGroup;if(!a)return true;if(a.expanded===false)return false;while(a=a.parentGroup)if(a.expanded===false)return false;return true},expandGroup:function(a){this.doRender();this.updateSources&&this.updateSources(a);if(this.olap.store.onGroupExpand(this,a)===false)return false;if(a&&!this.isExpandable())return false;var b=this.sumGroup;a?this.addClass("expanded"):this.removeClass("expanded");this.expanded=a;this.groups.each(function(b){if(a&&(!b.olap.hideSummary||b.olap.hideSummary&&b.isSummary()!==true)){!b.rendered&&b.expand(false,true);b.show()}else b.rendered&&b.hide()});if(b&&this.olap.hideSummary!==true)a?b.el.show():b.el.hide();return true},getRowsCount:function(){var b=this,c=b.sumGroup,a=this.olap.hideSummary?function(c,b){ui.each(c.groups,function(c){if(!c.isSummary())if(c.expanded==true)if(c.groups.length)b=a(c,b);else b++;else b++});return b}:function(d,b){ui.each(d.groups,function(e){if(e.expanded==true)if(e.groups.length)b=a(e,b);else b++;else if(!e.sumGroup||d.sumGroup&&d.sumGroup.field.sum)b++;if(e.field.sum&&e===c)b--});return b};return b.expanded?a(b,0)||1:1},show:function(){this.sumGroup&&this.olap.hideSummary!==true&&this.sumGroup.show();if(this.parentGroup)this.parentGroup.expanded&&this.base();else this.base()},hide:function(){this.sumGroup&&this.sumGroup.hide();this.base()},onResize:function(){},onResizeEnd:function(){}}});ui.define({name:"ui.olap.Row",type:"olapRow",base:"olapGroup",data:{query:null,init:function(a){this.base(a)},render:function(){this.base();ui.DragAndDropManager.add(this.view.getBox("title.resize"))},select:function(c,e){var a=this,b=this;if(this.sumGroup&&this.expanded!==true){a=this.sumGroup;b=this.sumGroup}if(this.groups.length&&this.expanded){a=this.groups[0];b=this.groups[this.groups.length-1]}var d={row:a.index,col:0},f={row:b.index,col:this.olap.columnsCount-1};this.olap.selection.updateSelection(d,f,e,c)},expandGroup:function(a){if(!this.groups.length&&!this.field.summary){this.doRender();var b=this.dataField&&this.dataField.width||this.olap.columnWidth;this.view.getBox("title").setWidth(b)}return this.base(a)},expand:function(b,e,i){if(this.expandGroup(b)==false)return;this.updateIgnored(e);var l=this.view.getBox("title"),a=this.olap,c=this.sumGroup,d=0,f=a.columnHeight,g=a.rowsFields,j=this.dataField?this.dataField.width||a.columnWidth:a.columnWidth,k=this.level,h=this.parentGroup;g.slice(g.length-k).each(function(b){d+=b.width||a.columnWidth});l.css(b?{height:this.getRowsCount()*f,width:j}:{width:d,height:f});this.css({"float":b?"none":"left"});if(c)if(a.hideSummary===true)c.hide();else{c.el.insertAfter(this.el);c.doRender();c.view.getBox("title").setWidth(d)}(b||e!==true)&&h&&i!==false&&h.expand(true,true);if(e!==true){a.view.updateDataSize();this.fire("expand",b)}this.fire("silent_expand",b)},updateIgnored:function(d){if(!this.sumGroup&&!this.groups.length)return;for(var b=this.index,c=this.sumGroup.index,a=this.olap;b<c;b++)this.expanded?delete a._ignore["y:"+b]:(a._ignore["y:"+b]=1);this.expanded&&ui.each(this.groups,function(a){a.updateIgnored(true)});if(this.olap.hideSummary)this.expanded?(a._ignore["y:"+c]=1):delete a._ignore["y:"+c];d!==true&&a.dataScroll()},onResize:function(g){var b=this.olap,e=b.view,f=this.expanded&&!this.summary?this.dataField:b.rowsFields[b.rowsFields.length-1],c=b.offset(),a=f.dataGroup.offset(),d=g.clientX-c.left;if(d-a.left<50)d=a.left+50;e.getBox("resize-left").css({display:"block",left:a.left-c.left,top:a.top-c.top});e.getBox("resize-right").css({display:"block",left:d,top:a.top-c.top})},onResizeEnd:function(f){var a=this.olap,b=a.view,d=this.expanded&&!this.summary?this.dataField:a.rowsFields[a.rowsFields.length-1],e=d.dataGroup.offset(),c=f.clientX-e.left;if(c<50)c=50;d.dataGroup.setFieldWidth(c);b.updateSize();a.dataScroll();b.getBox("resize-left").hide();b.getBox("resize-right").hide()}}});ui.define({name:"ui.olap.Column",type:"olapColumn",base:"olapGroup",data:{init:function(a){this.base(a)},render:function(){this.base();var d=this.view.getBox("title");d.css("minWidth","auto");if(this.source){var b=this.parentGroup,e=b.sumGroup?b.sumGroup:b,a=this,c=function(){a.olap.getColumn(a.index).startIndex=a.startIndex};e.ready?c():e.on("ready",c);this.single()}else this.renderSources();!this.hasSources()&&!this.groups.length&&this.level==this.olap.colGroups.length&&d.css("width",this.olap.columnWidth);this.renderUtils()},select:function(c,e){var b=this,a=this;if(this.sumGroup&&this.expanded!==true){b=this.sumGroup;a=this.sumGroup}if(this.groups.length&&this.expanded){b=this.groups[0];a=this.groups[this.groups.length-1]}if(a.sources)a=a.sources[a.sources.length-1];var d={row:0,col:b.index},f={row:this.olap.rowsCount-1,col:a.index};this.olap.selection.updateSelection(d,f,e,c)},renderUtils:function(){var g=this.olap,f=this.view.getBox("title.resize");ui.DragAndDropManager.add(f);if(this.field&&this.field.summary)return;if(this.source||!this.hasSources()&&!this.groups.length){this.view.getBox("title.span").on("dblclick",this.fitColumn,this);if(!this.parentGroup)return;var d=this.parentGroup,b=d.sumGroup?d.sumGroup:d,a=this,e=function(){a.olap.getColumn(a.index).group=a};if(g.autoFitColumns){var c=function(){a.fitColumn(true)};if(this.source)b.ready?c():b.on("ready",c);else c()}if(this.source)b.ready?e():b.on("ready",e)}},fitColumn:function(a){if(this.groups.length)return;this.setColumnWidth(this.olap.getWordWidth(this.title)+16,a)},setColumnWidth:function(a,c){var b=this.olap,d=this.view.getBox("title"),e=b.getColumn(this.index);e.columnWidth=a;d.css({width:a,minWidth:a});if(c!==true){b.dataScroll();b.view.updateSize()}},renderSources:function(){if(!this.hasSources())return;var c=this.olap,a=this.sumGroup?this.sumGroup.index:this.index,b=a;this.sources=[];ui.each(c.dataFields,function(d,e){var c=ui.instance({source:true,sourceIndex:e,extraCls:"single",type:"olapColumn",title:d.header,field:this.dataField,index:a,startIndex:b,parent:this.getBody(),parentGroup:this,autoRender:false,olap:this.olap});a++;this.sources.push(c)},this);this.view.getBox("title").css("width","auto")},hasSources:function(){return this.olap.dataFields.length>1},updateSources:function(a){if(!this.hasSources())return;ui.each(this.sources,function(b){b.doRender();var c=this.olap.getColumn(b.index);if(a)b.el.hide();else{var d=b.view.getBox("title"),e=c&&c.columnWidth||this.olap.columnWidth;d.setWidth(e);b.el.show()}},this);this.sumGroup&&this.sumGroup.updateSources(false)},expand:function(b,g){if(this.expandGroup(b)==false)return;this.updateIgnored(g);var a=this.olap,h=this.view.getBox("title"),f=a.columnHeight,d=this.hasSources()?"auto":a.columnWidth,c=this.sumGroup,e=a.getColumn(c?c.index:null);if(b==false&&this.hasSources()==false&&e)d=e.columnWidth||a.columnWidth;h.css(b?{height:f,width:"auto"}:{height:this.level*f,width:d});if(b&&c){d=e&&e.columnWidth||a.columnWidth;c.doRender();c.el.appendTo(this.el);c.view.getBox("title").css({height:c.sumHeight,width:this.hasSources()?"auto":d})}b&&!this.hasSources()&&this.groups.each(function(b){if(b.groups.length)return false;var d=b.view.getBox("title"),c=a.getColumn(b.index);d.css({width:c&&c.columnWidth||a.columnWidth})},this);if(g!==true){a.view.updateDataSize();this.fire("expand",b)}this.fire("silent_expand",b)},updateIgnored:function(d){if(!this.sumGroup&&!this.groups.length)return;for(var b=this.index,c=this.sumGroup.index,a=this.olap;b<c;b++)this.expanded?delete a._ignore["x:"+b]:(a._ignore["x:"+b]=1);this.expanded&&ui.each(this.groups,function(a){a.updateIgnored(true)});if(this.olap.hideSummary)this.expanded?(a._ignore["x:"+c]=1):delete a._ignore["x:"+c];d!==true&&a.dataScroll()},onResizeEnd:function(e){var d=this.olap,b=d.view,a=this.getResizeGroup(),c=a.getColumnWidth(e);if(a.hasSources()==false){if(!this.expanded){this.view.getBox("title").css({width:c});if(a.sumGroup){a.sumGroup.doRender();a=a.sumGroup}}}else this!==a&&this.view.getBox("title").css({width:"auto"});a.setColumnWidth(c);b.getBox("resize-left").hide();b.getBox("resize-right").hide()},onResize:function(e){var c=this.olap.view,a=this.view.getBox("title.span").offset(),b=this.olap.offset(),d=a.left+this.getColumnWidth(e)-b.left;c.getBox("resize-left").css({display:"block",left:a.left-b.left,top:a.top-b.top});c.getBox("resize-right").css({display:"block",left:d,top:a.top-b.top})},getResizeGroup:function(){var a=this,b=a.groups,d=a.sources,c=a.sumGroup;if(a.hasSources()){if(!a.source){if(a.expanded&&c)a=c;a=d[d.length-1]}}else if(a.expanded&&b.length)a=b[b.length-1];return a},getColumnWidth:function(d){var b=50,c=this.view.getBox("title.span").offset(),a=d.clientX-c.left;return a>b?a:b}}});ui.define({name:"ui.olap.FieldMenuView",type:"olapfieldmenu_view",base:"view",data:{viewConfig:function(){return[{name:"tbar",items:[{name:"select-all",extraCls:"ui-btn",html:'<span class="icon"></span>'},{name:"unselect-all",extraCls:"ui-btn",html:'<span class="icon"></span>'},{name:"reverse",extraCls:"ui-btn",html:'<span class="icon icon-reverse"></span>'},{name:"asc",extraCls:"ui-btn",html:'<span class="icon icon-asc"></span>'},{name:"desc",extraCls:"ui-btn",html:'<span class="icon icon-desc"></span>'}]},{name:"body",items:["groups"]},{name:"bbar",items:[{name:"yes",extraCls:"ui-btn",html:'<span class="text">Принять</span>'},{name:"no",extraCls:"ui-btn",html:'<span class="text">Отмена</span>'}]}]},getBody:function(){return this.getBox("body")}}});ui.define({name:"ui.olap.FieldMenu",type:"olapfieldmenu",base:"control",data:{cls:"ui-fieldmenu",viewType:"olapfieldmenu_view",render:function(){this.base();ui.EventsManager.on("mousedown",this.onDocumentClick,this);this.view.getBox("bbar.yes").on("click",this.apply,this);this.view.getBox("bbar.no").on("click",this.hide,this);this.view.getBox("tbar.select-all").on("click",this.selectAll,this);this.view.getBox("tbar.unselect-all").on("click",this.unSelectAll,this);this.view.getBox("tbar.asc").on("click",function(){this.renderValues("ASC")},this);this.view.getBox("tbar.desc").on("click",function(){this.renderValues("DESC")},this);this.view.getBox("tbar.reverse").on("click",function(){this.reverseValues()},this)},show:function(){this.renderValues(this.sort);this.base()},reverseValues:function(){var a=this.getFilter(),b=this.view.getBox("body.groups").find(".menu-value");b.removeClass("checked").each(function(){a.contains($(this).html())===false&&$(this).addClass("checked")})},renderValues:function(a){var d=this.view.getBox("body.groups"),b=this,c=b.field;c.getGroups(function(f){var h=function(a){return ui.instance({type:"element",cls:"menu-value",parent:d,html:a})},i=b.getFilter(),g=c.field.filter,e="checked";d.empty();(a=="ASC"||a=="DESC")&&f.sort();a=="DESC"&&f.reverse();f.each(function(c){var b=h(c);if(a)i.contains(c)!==false&&b.addClass(e);else g&&g.contains(c)!==false&&b.addClass(e);b.on("click",function(){b.hasClass(e)?b.removeClass(e):b.addClass(e)},this)},b)})},unSelectAll:function(){this.view.getBox("body.groups").find(".menu-value").removeClass("checked")},selectAll:function(){this.view.getBox("body.groups").find(".menu-value").addClass("checked")},updateFilter:function(a){this.field.field.filter=a;this.olap.filter()},clear:function(){this.hide();this.updateFilter(null)},getFilter:function(){var a=[];this.view.getBox("body.groups").find(".checked").each(function(){a.push($(this).html())});return a},hide:function(){this.base()},apply:function(){var a=this.getFilter();this.hide();this.updateFilter(a)},onDocumentClick:function(a){var b=this.field.view.getBox("title.body.tools");!this.hasDom(a.target)&&b.el.get(0)!==a.target&&this.hide()}}});ui.define({name:"ui.olap.FieldView",type:"olapField_view",base:"view",data:{viewConfig:function(){return[{name:"title",items:[{name:"body",items:["text","tools","drag-zone"]}]},"drop"]},getDragZone:function(){return this.getBox("title.body.drag-zone")},getBody:function(){return this.control}}});ui.define({name:"ui.olap.Field",type:"olapField",base:"control",data:{viewType:"olapField_view",cls:"group",field:null,init:function(b){var d=b.olap,c=d.fields,a=d.id,e="o-field-"+a;b.dropZone=e;b.dropZones=[e,"o-data-"+a,"o-filter-"+a,"o-cols-"+a,"o-rows-"+a];this.base(b);this.on("drop",function(a,f,e){var b=c.contains(this.field);a.field.area=this.field.area;c.remove(a.field);c.add(a.field,e=="after"?b+1:b);d.redraw()},this)},render:function(){this.base();var a=this.field,b=this.view.getBox("title"),d=this.view.getBox("title.body.text"),c=this.view.getBox("title.body.tools");d.setHtml(this.title);if(a.area!="data"){if(a.sort=="ASC")b.addClass("asc");else a.sort=="DESC"&&b.addClass("desc");d.on("click",function(){if(this.field.sort=="ASC")this.field.sort="DESC";else if(this.field.sort=="DESC")delete this.field.sort;else this.field.sort="ASC";this.olap.sort()},this);c.on("click",this.showMenu,this)}else c.hide();a.filter&&a.filter.length&&this.addClass("filtered")},getGroups:function(a){this.olap.store.getGroups(this.field,a)},showMenu:function(){if(!this.menu)this.menu=ui.instance({type:"olapfieldmenu",field:this,parent:this.view.getBox("title.body"),olap:this.olap});this.menu.show()},setFieldWidth:function(b){this.field.width=b;this.view.getBox("title").css({width:b});var a=function(b){if(!b.rendered)return;if(b.load||b.load!==false){b.expand(b.expanded,true);b.groups.each(a)}else b.expand(false,true)};this.olap.rootRows.each(a);this.olap.view.updateSize()},fitField:function(){var a=this.field.width;if(!a)a=this.olap.getWordWidth(this.title)+45;this.setFieldWidth(a)},createDragElement:function(){return'<div class="ui-olap-group-drag">'+this.title+"</div>"},getDropZone:function(){return this.view.getBox("title")}}});ui.define({name:"ui.olap.Selection",type:"olap.Selection",base:"base",data:{init:function(a){this.base(a);this._selection={};this._selected={map:{}};this.olap.on("renderEnd",this.initOlap,this)},getCoords:function(c){var a=this.olap.view.getBox("data"),b=a.offset();return{x:c.clientX-b.left+a.scrollLeft(),y:c.clientY-b.top+a.scrollTop()}},getCell:function(a){var b=parseInt(a.attr("ui:x")),c=parseInt(a.attr("ui:y"));return{col:b,row:c}},initOlap:function(){var a=this.olap.view.getBox("data"),b=ui.instance({type:"element",cls:"ui-olap-selection",parent:a});this.element=b;ui.DragAndDropManager.add(a);a.on("dragStart",this.onDragStart,this);a.on("drag",this.onDrag,this);a.on("drop",this.onDrop,this);this.olap.on("renderCell",this.onRenderCell,this);this.element=b},checkSelection:function(b,a){if(!a.hasClass("ui-data-resizer")){if(!a.hasClass("ui-data-cell"))a=a.parents(".ui-data-cell");if(a.hasClass("ui-data-cell")){this._selection.end=this.getCell(a);if(!this._selection.start)this._selection.start=this.getCell(a)}return true}return false},onDrop:function(a){var b=$(a.target),c=this.element;if(this.checkSelection(a,b)){c.hide();if(this.start){this.updateSelection(this._selection.start,this._selection.end,a.ctrlKey?"merge":null);this.clear();delete this.start}}else if(this.start){this.clear();delete this.start}},onDragStart:function(a){var b=$(a.target),c=this.element;this.clear();if(this.checkSelection(a,b)){this.start=this.getCoords(a);c.css({left:this.start.x,top:this.start.y,width:0,height:0,display:"block"})}},onDrag:function(c){var d=$(c.target),b=this.element;if(this.checkSelection(c,d)&&this.start){var a=this.getCoords(c);a.x>this.start.x?b.css({width:a.x-this.start.x}):b.css({width:this.start.x-a.x,left:a.x});a.y>this.start.y?b.css({height:a.y-this.start.y}):b.css({height:this.start.y-a.y,top:a.y})}},updateSelection:function(c,d,q,m){if(!c||!d){this._selected={map:{}};this.olap.dataScroll();m!==true&&this.fire("selectionchange",[this,null]);return}var g=c.col,h=c.row,j=d.col,k=d.row,e,p,o,l,n=true,f,i;if(g>j){j=c.col;g=d.col}if(h>k){k=c.row;h=d.row}if(q!="merge")this._selected={map:{},data:[],rows:[],cols:[]};for(var b=h;b<=k;b++){if(this.olap.isIgnoredY(b))continue;l=this.olap.getRow(b);i=this._selected.rows.contains(l.getName());f=false;if(i!==false)e=this._selected.data[i];else{e=[];f=true;this._selected.rows.push(l.getName())}for(var a=g;a<=j;a++){if(this.olap.isIgnoredX(a)||this._selected.map[a+":"+b])continue;p=this.olap.getCellValue(a,b);o=this.olap.getColumn(a);n&&this._selected.cols.push(o.group.getName());e.push(p.value);this._selected.map[a+":"+b]=1}f&&this._selected.data.push(e);n=false}this.olap.dataScroll();m!==true&&this.fire("selectionchange",[this,this.getSelected()])},getSelected:function(){return{data:this._selected.data,cols:this._selected.cols,rows:this._selected.rows}},onRenderCell:function(a,e,d,b,c){this._selected.map[b+":"+c]&&a.append('<div class="selected-cell"></div>')},clear:function(){this._selection={}}}});ui.define({name:"ui.olap.store.Base",type:"ui.olap.store.Base",base:"base",data:{init:function(a){a=a||{};this._groups={};this.base(a)},getColumnsData:function(){},getRowsData:function(){},getFilters:function(){var a={},b=false;this.olap.fields.each(function(c){if(c.filter&&c.filter.length){a[c.dataIndex]=c.filter;b=true}});return b?a:null},sort:function(){this.olap.redraw()},getGroups:function(a,b){var c=this._groups;if(!c[a])this._getGroups(a,function(d){c[a]=d;b&&b(d)});else b&&b(c[a])},listData:function(c,e,b,a){var d=this.olap;b&&ui.each(e,function(a){ui.each(c,function(c){d.renderCell(c,a,b)})});a&&a()},loadDataSource:function(a){a()},filter:function(){this.fire("update",[this])},onGroupExpand:function(a){if(a.mainRowSummary)return true;if(a.field.summary||!a.groups.length){a.single();return false}return true},_getGroups:function(){}}});ui.define({name:"ui.olap.store.Array",type:"ui.olap.store.Array",base:"ui.olap.store.Base",data:{init:function(a){a=a||{};this.data=ui.array(a.data||[]);delete a.data;this.base(a)},getColumnsData:function(b,c){var a=b.length>0?this.groupBy(b.slice(0)):this.getRecords(),d=a.length?this._getLevel(a[0]):1;c(a,d)},getRowsData:function(c,b){var a=this.groupBy(c.slice(0)),d=a.length?this._getLevel(a[0]):1;b(a,d)},getGroups:function(a,b){this.base(ui.isString(a)?a:a.dataIndex,b)},filter:function(a){this.fire("beforeFilter",[this]);this.records=ui.array(this.data.find(a));this.fire("afterFilter",[this]);this.fire("update",[this,this.records]);return this.records},sort:function(a){this.sorters=a;this.fire("update",[this,this.records])},find:function(a){return this.records.find(a)},groupBy:function(a){return this.records.groupBy(a,this.sorters)},getRecords:function(){return this.records.list},_getLevel:function(a){var b=1;while(a.items&&a.items[0]){b++;a=a.items[0]}return b},_getGroups:function(b,a){a(this.data.getGroups(b))}}});ui.define({name:"ui.olap.store.XMLA",type:"ui.olap.store.XMLA",base:"ui.olap.store.Base",data:{init:function(a){a=a||{};this._xmla=new Xmla;this.base(a)},filter:function(a){console.log(a);this.base(a)},getFilters:function(){var a={},b=false;this.olap.fields.each(function(c){if(c.filter&&c.filter.length){a[this.getDataIndex(c)]=c.filter;b=true}},this);return b?a:null},getGroups:function(a,b){if(ui.isString(a))a=this.olap.fields.findOne({dataIndex:a});this.base(this.getDataIndex(a),b)},_getGroups:function(b,a){this.execute({statement:"SELECT "+b+".Members ON AXIS(0) from ["+this.xmla.cube+"]",success:function(e,f,d){var c=d.getAxis(0),b=[];c.eachHierarchy(function(a){c.eachTuple(function(c){b.push(c.hierarchies[a.name].Caption)})});a&&a(b)}})},_getPath:function(b,f){var h=b.data.sum,e=b.group,g=h?e.level+1:e.level,c=h?e.parentGroup.parentGroup:e.parentGroup,a=[b.data?b.data.path:b.field.path],d=[],i=function(b){var a=-1;ui.each(d,function(c,d){if(b.indexOf(c)>=0){a=d;return false}});return a};while(c){a.push(c.field.path);c=c.parentGroup}g>1&&ui.each(f.slice(f.length-g+1),function(c){var b="["+c.hierarchy+"]";a.join(",").indexOf(b)<0&&a.push(b)});a.sort();ui.each(a,function(a){var b=i(a);if(b>=0)d[b]=a;else d.push(a)});return d.join(",")},_getColumnPath:function(b){var a=this.olap;return this._getPath(a.getColumn(b),a.colsFields)},_getRowPath:function(b){var a=this.olap;return this._getPath(a.getRow(b),a.rowsFields)},listData:function(b,c,f,i){var g=[],h=[],d={x1:b[0],x2:b[b.length-1],y1:c[0],y2:c[c.length-1]},e=this.olap,a=e._matrix;if(f&&a[d.x1]&&a[d.x2]&&a[d.x1][d.y1]&&a[d.x2][d.y2]){this.base(b,c,f);return}ui.each(b,function(a){e.getColumn(a)&&g.push("("+this._getColumnPath(a)+",[Measures].[Unit Sales])")},this);ui.each(c,function(a){e.getRow(a)&&h.push("("+this._getRowPath(a)+")")},this);if(!h.length||!g.length)return;var j=["select {",g.join(","),"} ON COLUMNS, {",h.join(","),"} ON ROWS FROM ["+this.xmla.cube+"]"];this.execute({statement:j.join(" "),success:function(p,q,l){for(var o=l.getCellset(),m=l.getColumnAxis().tupleCount(),n=l.getRowAxis().tupleCount(),d,k,j,g=0;g<n;g++)for(var h=0;h<m;h++){j=o.getByTupleIndexes(g,h);k=c[g];d=b[h];if(!a[d])a[d]={};a[d][k]={value:j?j.Value||0:0};f&&e.renderCell(d,k,f)}i&&i()}})},getColumnsData:function(b,a){a(this._cols,this.olap.colsFields.length+1);ui.each(this.olap.rootColumns,function(a){a.expand(false)})},getRowsData:function(b,a){a(this._rows,this.olap.rowsFields.length+1)},execute:function(a){a.url=this.xmla.url;this._xmla.execute(a)},onGroupExpand:function(a,p){var e=a.type=="olapColumn";if(!a.load){var m=this,g=this.olap,j=e?g.colsFields:g.rowsFields,n=a.dataField||ui.array(j).findOne(function(b){return m.getDataIndex(b)==a.field.code},this),o=j.contains(n),c=j[o+1],d=["SELECT"],h,f=[],i,b=a,l=function(a,b,c){g.renderRow(a,b,c)},k;a.dataField=n;if(p&&c){k=this.getDataIndex(c);while(b){if(b.field.path.indexOf(c.hierarchy)>=0){if(!h||h.length<b.field.path.length)h=b.field.path}else{i=true;ui.each(f,function(a,c){if(b.field.path.indexOf(a)>=0){f[c]=b.field.path;i=false;return false}if(a.indexOf(b.field.path)>=0){i=false;return false}});i&&f.push(b.field.path)}b=b.parentGroup}(c.sort=="ASC"||c.sort=="DESC")&&d.push("Order(");h?d.push("EXISTS("+k+".Members, {"+h+"})"):d.push(k+".Members");(c.sort=="ASC"||c.sort=="DESC")&&d.push(","+k+".CurrentMember.CAPTION,B"+c.sort+")");d.push("ON AXIS(0)");d.push("FROM ["+this.xmla.cube+"]");if(f.length){d.push("WHERE");d.push(f.join(","))}if(e)l=function(a,b,c){g.renderColumn(a,b,c)};this.execute({statement:d.join(" "),success:function(h,i,f){var c=f.getAxis(0),b=j.length-o,d=function(d,c){for(var b=[],a=0;a<=c.index;a++)b.push(d.members[a][Xmla.Dataset.Axis.MEMBER_UNIQUE_NAME]);return b.join()};c.eachHierarchy(function(e){c.eachTuple(function(c){l({path:d(c,e),group:c.hierarchies[e.name].Caption,code:c.hierarchies[e.name].LName,expanded:false,groups:[],items:[]},a,b)})});l({path:a.field.path,group:"<b>Итого "+a.field.group+"</b>",sum:true,code:a.field.code,expanded:false,groups:[],items:[]},a,e?b:b+1);a.expanded=false;a.load=true;g._matrix={};a.expand(true,true);e?m._updateColsIndexes():m._updateRowsIndexes();a.expand(true)},error:function(){}});return false}if(!c){a.load=true;a.single();a.expand(false);return false}}else if(!e&&a.sumGroup)delete this.olap._ignore["y:"+a.sumGroup.index]},_updateRowsIndexes:function(){var c=[],a=this.olap,b=function(d){if(d.groups.length)ui.each(d.groups,b);else{c.push({field:a.dataFields[0],data:d.field,group:d});d.index=a.rowsCount;a.rowsCount++;if(d.field.sum){d.parentGroup.sumGroup=d;d.parentGroup.index=d.parentGroup.groups[0].index;d.doRender();d.single()}}};a.rowsCount=0;ui.each(a.rootRows,b);a._rows=c},_updateColsIndexes:function(){var c=[],a=this.olap,b=function(d){if(d.groups.length)ui.each(d.groups,b);else{c.push({field:a.dataFields[0],data:d.field,group:d,columnWidth:a._cols[d.index]?a._cols[d.index].columnWidth:null});d.index=a.columnsCount;a.columnsCount++;if(d.field.sum){d.parentGroup.sumGroup=d;d.parentGroup.index=d.parentGroup.groups[0].index;d.doRender();d.single()}}};a.columnsCount=0;ui.each(a.rootColumns,b);a._cols=c},getDataIndex:function(a){return["[",a.hierarchy,"].[",a.dataIndex,"]"].join("")},loadDataSource:function(f){var a=this,d=a.olap.colsFields[0],e=a.olap.rowsFields[0],b=a.getDataIndex(d),c=a.getDataIndex(e);if(d.sort=="ASC"||d.sort=="DESC")b="Order("+b+".Members, "+b+".CurrentMember.CAPTION,B"+d.sort+")";else b+=".Members";if(e.sort=="ASC"||e.sort=="DESC")c="Order("+c+".Members, "+c+".CurrentMember.CAPTION,B"+e.sort+")";else c+=".Members";this.execute({statement:"SELECT "+b+" ON Axis(0), "+c+" ON Axis(1) FROM ["+this.xmla.cube+"]",success:function(g,h,e){var c=e.getAxis(0),d=e.getAxis(1),b=function(d,c){for(var b=[],a=0;a<=c.index;a++)b.push(d.members[a][Xmla.Dataset.Axis.MEMBER_UNIQUE_NAME]);return b.join()};a._cols=[];a._rows=[];c.eachHierarchy(function(d){c.eachTuple(function(c){a._cols.push({path:b(c,d),group:c.hierarchies[d.name].Caption,code:c.hierarchies[d.name].LName,groups:[],items:[]})})});d.eachHierarchy(function(c){d.eachTuple(function(d){a._rows.push({path:b(d,c),group:d.hierarchies[c.name].Caption,code:d.hierarchies[c.name].LName,groups:[],items:[]})})});f();a._updateColsIndexes();a._updateRowsIndexes();a.olap.view.updateSize();a.olap.dataScroll()},error:function(){}})}}});ui.define({name:"ui.olap.Olap",type:"olap",base:"control",data:{cls:"ui-olap",viewType:"olap.view",layout:"olap.Layout",selection:"olap.Selection",sumColumn:{group:"<b>Итого</b>",summary:true,items:[]},columnHeight:22,columnWidth:100,columnSummary:true,rowSummary:true,hideSummary:false,layoutName:null,stateId:"olap",init:function(a){a=a||{};this._ignore={};this._fitted={};this._source={};this.defaultFields=[];this.defaultLayout=a.layoutName;this.fields=a.fields instanceof ui.Array?a.fields:ui.array(a.fields);this.fields.each(function(a){this.defaultFields.push(ui.clone(a))},this);this.store=this.createStore(a);delete a.store;delete a.fields;this.base(a)},initDragDrop:function(){ui.DragAndDropManager.addDropZone(this,"o-cols-"+this.id);ui.DragAndDropManager.addDropZone(this,"o-rows-"+this.id);ui.DragAndDropManager.addDropZone(this,"o-data-"+this.id);ui.DragAndDropManager.addDropZone(this,"o-filter-"+this.id);this.on("drop",function(b,d,c,a){if(a.indexOf("o-cols-")>=0)b.field.area="columns";if(a.indexOf("o-rows-")>=0)b.field.area="rows";if(a.indexOf("o-data-")>=0)b.field.area="data";if(a.indexOf("o-filter-")>=0)b.field.area="filter";this.redraw()},this)},createStore:function(a){return ui.instance(ui.isArray(a.store)?{}:a.store,{olap:this,type:"ui.olap.store.Array",data:ui.isArray(a.store)?a.store:[],listeners:{scope:this,update:this.redraw}})},createLayout:function(){return ui.instance({type:this.layout,olap:this})},createSelection:function(){return ui.instance({type:this.selection,olap:this})},render:function(){this.base();var a=this;$(window).resize(function(){a.view.updateSize();a.dataScroll()});this.initDragDrop();this.view.on("scrollEnd",this.dataScroll,this);this.layout=this.createLayout();this.selection=this.createSelection();this.fire("layout",[this.layout,this]);if(!this.layout.setLayout(this.layoutName)){this.store.sorters=this.getSorters();this.filter.defer(1,this)}},clear:function(){var a=this.view,d=a.getBox("data-cols"),b=a.getBox("filter-cols"),c=a.getBox("cols-cols"),e=a.getBox("rows-cols");d.empty();b.empty();c.empty();e.empty();this._cols=[];this._rows=[];this._matrix={};this._ignore={};this._fitted={};this._source={};this.rootColumns=[];this.rootRows=[];this.fields=this.fields instanceof ui.Array?this.fields:ui.array(this.fields);this.dataFields=this.fields.find({area:"data"});this.rowsFields=this.fields.find({area:"rows"});this.colsFields=this.fields.find({area:"columns"});this.filterFields=this.fields.find({area:"filter"});this.selection.clear()},renderZone:function(b,a){var c=function(a){a.setHtml('<div class="empty-zone">'+a.html+"</div>")};if(a.length)ui.each(a,function(a){a.dataGroup=this.renderGroup(b,a,"olapField")},this);else c(b)},redraw:function(){var a=this,b=a.view;this.clear();this.store.loadDataSource(function(){a.renderZone(b.getBox("filter-cols"),a.filterFields);a.renderZone(b.getBox("data-cols"),a.dataFields);a.renderZone(b.getBox("cols-cols"),a.colsFields);a.renderZone(b.getBox("rows-cols"),a.rowsFields);a.renderColumns(a.colsFields);a.renderRows();b.updateSize();a.dataScroll();a.fire("redraw",a)})},getWordWidth:function(a){if(this._fitted[a])return this._fitted[a];var b=$("<span/>").hide().addClass("ui-text-metric").html(a||"").prependTo("body");this._fitted[a]=b.width();b.remove();return this._fitted[a]},getFilters:function(){return this.store.getFilters()},getSorters:function(){var a=[];this.fields.each(function(b){b.sort&&a.push({dir:b.sort,code:b.dataIndex})});return a},filter:function(){var a={filters:this.getFilters(),sorters:this.getSorters()};this.fire("beforefilter",[this,a]);this.store.sorters=a.sorters;this.store.filter(a.filters)},sort:function(){this.store.sort(this.getSorters())},isIgnoredY:function(a){return this._ignore["y:"+a]==1},isIgnoredX:function(a){return this._ignore["x:"+a]==1},getSourceData:function(a){return this._source[a]},setSourceData:function(b,a){this._source[b]=a},dataScroll:function(){var d=this.view.getBox("data"),m=this.view.getBox("data.layout"),c=$('<div style="position: absolute;"/>'),A=d.outerWidth(),z=d.outerHeight(),s=d.scrollLeft(),y=d.scrollTop(),r=this.columnWidth,e=this.columnHeight,j=0,t=Math.ceil(z/e)+1,l=Math.floor(y/e),b=0,f=0,n=0,a=0,g=0,v=s-100,k=0,w=s+A+100,i=[],p=[],x=this.rowsCount;m.empty();while(f<w&&a<this.columnsCount){if(this.isIgnoredX(a)){a++;continue}var q=this.getColumn(a),h=q&&q.columnWidth||r;f+=h;if(f>v){i.push(a);n+=h}else k+=h;a++}c.css({left:k,width:n,top:l*e});while(g<t&&b<x){if(this.isIgnoredY(b)){b++;continue}if(j>=l){p.push(b);g++}j++;b++}this.store.listData(i,p,c);var o=0,u=e*g;i.each(function(d){var a=this.getColumn(d),b=ui.instance({type:"element",cls:"ui-data-resizer",listeners:{scope:this,drop:function(b){this.onCellResizeEnd(b,a)},drag:function(b){this.onCellResize(b,a)}}});ui.DragAndDropManager.add(b);o+=a&&a.columnWidth||r;b.css({left:o,height:u});b.appendTo(c)},this);c.appendTo(m.el);this.fire("dataScroll",this)},onCellResize:function(h,g){var d=this.view,f=this.getResizeGroup(g.group),a=f.offset(),c=this.offset(),e=50,b=h.clientX-a.left;b=b>e?b:e;d.getBox("resize-left").css({display:"block",left:a.left-c.left,top:a.top-c.top});d.getBox("resize-right").css({display:"block",left:a.left+b-c.left,top:a.top-c.top})},onCellResizeEnd:function(g,b){var d=this.view,a=this.getResizeGroup(b.group),f=a.offset(),e=50,c=g.clientX-f.left;d.getBox("resize-left").hide();d.getBox("resize-right").hide();b.columnWidth=c>e?c:e;if(a.source)a.parentGroup.updateSources(false);else if(a.groups.length)a.expand(false,true);else a.view.getBox("title").css({width:b.columnWidth,minWidth:b.columnWidth});this.view.updateSize();this.dataScroll()},getResizeGroup:function(b){var a=b.parentGroup;if(b.source){if(a.sumHeight&&a.parentGroup.expanded!==true)return a.parentGroup.sources[b.sourceIndex]}else if((b.sumHeight||b.field.sum)&&a&&a.expanded!==true)return a;return b},renderCell:function(c,d,j){var a=this.getCellValue(c,d),g=this.getRow(d),i=this.getColumn(c),b=$('<div class="ui-data-cell" ui:x="'+c+'" ui:y="'+d+'"></div>'),h=a.field,f=ui.olap.Types[h.type],e=f?f.renderer:null;if(a.summary){e=a.field&&a.field.summaryRenderer?a.field.summaryRenderer:g.summary&&g.data.summaryRenderer?g.data.summaryRenderer:e;b.addClass("ui-data-sum-cell")}b.html(e?e(a.value,f,h,this,c,d):a.value);b.width((i&&i.columnWidth||this.columnWidth)-5);this.fire("renderCell",[b,a,this,c,d]);b.appendTo(j);return b},getCellValue:function(b,c){if(!this._matrix[b])this._matrix[b]={};if(this._matrix[b][c])return this._matrix[b][c];var a=this.getColumn(b),f=this.getRow(c),i=a.data.items,g=a.field?a.field.dataIndex:null,d={value:0},e=this,k=ui.olap.Types[a.field.type],l=k.summary||function(){};if(a.data.summary){var m=[a.startIndex,c].join(":"),j,h=a.field.summaryFn?function(f){a.field.summaryFn(d,f,g,a.field,e,b,c)}:function(f){l(d,f,g,a.field,e,b,c)};if(a.startIndex)if(j=this.getSourceData(m))for(var n=j.length;n--;)h(j[n]);else this.setSourceData(m,ui.array(i).find(f.query,h));else ui.array(i).find(f.query,h);k.format(d,g,a.field,e,b,c);d.summary=true}else{if(a.field){var o=a.field.valueFn||function(g,f,d){l(g,f,d,a.field,e,b,c)};ui.array(i).find(f.query,function(f){o(d,f,g,a.field,e,b,c)});k.format(d,g,a.field,e,b,c)}if(f.summary||f.mainRowSummary)d.summary=true}d.field=a.field;this._matrix[b][c]=d;return d},getColumn:function(a){return this._cols[a]},getRow:function(a){return this._rows[a]},renderRows:function(){var d=this.view.getBox("rows.layout"),c=ui.array(this.rowsFields).map("dataIndex"),b=$("<div/>"),a=this;this.rowGroups=c;this.rowsCount=0;d.empty();this.store.getRowsData(c,function(g,f){ui.each(g,function(c){a.renderRow(c,b,f)},a);if(a.rowSummary){var e=ui.clone(a.sumColumn);e.mainRowSummary=true;a.renderRow(e,b,c.length)}ui.instance({type:"clear",parent:b});b.appendTo(d.el)})},renderRow:function(c,f,d){if(!c.group&&!c.items)return null;var a=this.renderGroup(f,c,"olapRow");a.index=this.rowsCount;if(c.mainRowSummary){a.query={};a.mainRowSummary=true}else{d--;a.query=f.query?ui.clone(f.query):{};a.query[this.rowGroups[this.rowGroups.length-d]]=c.group}a.level=d;c.items.each(function(b){this.renderRow(b,a,d)},this);if(d<=1||c.mainRowSummary){this.rowsCount++;this._rows.push(a)}var e=this.fields.findOne({area:"rows",dataIndex:c.code});if(e&&e.summary!==false&&d>1){var g=ui.clone(this.sumColumn);g.group=e.summaryHeaderRenderer?e.summaryHeaderRenderer(c.group):"<b>Итого "+c.group+"</b>";var b=this.renderGroup(f,g,"olapRow");b.parentGroup=a;b.level=d;b.query=ui.clone(a.query);b.summary=true;b.data=e;b.autoRender=false;b.index=this.rowsCount;b.addClass("ui-row-sum-cell");a.sumGroup=b;this.rowsCount++;this._rows.push(b);b.ready=true;b.fire("ready")}a.ready=true;a.fire("ready");if(!a.parentGroup){a.expand(false,true);if(!a.groups.length){a.expanded=false;a.updateIgnored(true)}}return a},renderColumns:function(e){var a=this,f=this.view.getBox("cols"),d=this.view.getBox("cols.layout"),c=a.columnHeight,b=ui.array(e).map("dataIndex");this.colGroups=b;this.colFields=e;this.columnsCount=0;d.empty();this.store.getColumnsData(b,function(h,g){ui.each(h,function(b){a.renderColumn(b,d.el,g)},a);if(a.columnSummary){var e=ui.clone(a.sumColumn);e.code="";e.items=a.store.getRecords();e.summary=true;e.mainColumnSummary=true;a.renderColumn(e,d.el,g)}if(b.length)c=a.columnHeight*(a.dataFields.length>1?g:g-1);else if(a.dataFields.length>1)c=a.columnHeight*2;f.setHeight(c)})},renderColumn:function(c,d,b){if(ui.isEmpty(c.group)&&ui.isEmpty(c.items))return;var a=this.renderGroup(d,c,"olapColumn");b--;a.index=this.columnsCount;a.level=b;if(c.summary){a.sumHeight=b*this.columnHeight;if(d.type=="olapColumn"){d.sumGroup=a;(!d.parentGroup||this.colFields.length==1)&&d.expand(false,true)}else if(a.mainColumnSummary){a.expand(false,true);a.view.getBox("title").css({height:(b||1)*this.columnHeight})}this.renderColumnField(c,a);return}c.items.each(function(c){this.renderColumn(c,a,b)},this);if(b>1){var f=this.colFields[this.colFields.length-b+1];if(f.summary!==false){var e=ui.clone(this.sumColumn);e.code=f.dataIndex;e.items=this.getItems(c.items);e.summary=true;this.renderColumn(e,a,b)}}else{this.renderColumnField(c,a);this.colFields.length==1&&a.expand(false,true)}},renderColumnField:function(b,a){ui.each(this.dataFields,function(c){this.columnsCount++;this._cols.push({field:c,data:b,group:a})},this);a.ready=true;a.fire("ready")},renderGroup:function(b,c,d){var a=ui.instance({type:d,title:c.group||c.header,field:c,parent:b,mainColumnSummary:c.mainColumnSummary,autoRender:!!c.dataIndex,olap:this});if(b.type=="olapRow"||b.type=="olapColumn"){a.parentGroup=b;b.groups.push(a)}else if(d=="olapRow")this.rootRows.push(a);else d=="olapColumn"&&this.rootColumns.push(a);d=="olapField"&&a.fitField(true);return a},getItems:function(b){var a=[];if(b[0].items)b.each(function(b){a=a.concat(this.getItems(b.items))},this);else return b;return a},getLevel:function(a){var b=1;while(a.items&&a.items[0]){b++;a=a.items[0]}return b},getDropZone:function(b){var c=this.id,a=function(a){return a+c};switch(b){case a("o-cols-"):return this.view.getBox("cols-cols");case a("o-rows-"):return this.view.getBox("rows-cols");case a("o-data-"):return this.view.getBox("data-cols");case a("o-filter-"):return this.view.getBox("filter-cols")}return null}}});ui.define({name:"ui.olap.View",type:"olap.view",base:"view",data:{init:function(e){var c=new Date(1,1,2e3),a=false,b=100,d=function(){if(new Date-c<b)setTimeout(d,b);else{a=false;this.fire("scrollEnd")}}.delegate(this);this.base(e);this.on("scroll",function(){c=new Date;if(a===false){a=true;setTimeout(d,b)}})},viewConfig:function(){var a=this.control.id;return[{html:"Перетащите фильтры",name:"filter-cols"},{html:"Перетащите источники",name:"data-cols"},{name:"cols-cols",html:"Перетащите столбцы",dropZone:"o-cols-"+a},{name:"cols",items:["layout"]},{html:"Перетащите строки",name:"rows-cols"},{name:"rows",items:[{name:"layout"}],listeners:{scroll:function(){var a=this.getBox("data"),b=this.getBox("rows");a.scrollTop(b.scrollTop())}}},{name:"data",items:["layout"],listeners:{scroll:this.dataScroll}},"border","resize-left","resize-right"]},updateSize:function(){var j=this.control,g=this.getBox("cols"),o=this.getBox("rows"),k=this.getBox("filter-cols"),f=this.getBox("rows-cols"),h=this.getBox("data-cols"),e=this.getBox("cols-cols"),n=this.getBox("data"),p=this.getBox("border"),b=0;e.setHeight("auto");var l=h.outerHeight(),a=e.outerHeight(),d=k.outerHeight(),m=f.outerHeight(),c=g.outerHeight(),i=m+l,q=a+c;if(i>q){a=i-c;e.setHeight(a-1)}a+=d;j.rowsFields.each(function(a){b+=a.width||j.columnWidth});p.css({left:b,top:d});e.css({left:b,top:d});g.css({left:b,top:a});h.css({width:b,top:d});n.css({top:c+a,left:b});f.css({width:b,top:c+a-f.outerHeight()});o.css({width:b+30,top:c+a});this.fire("updateSize");this.updateDataSize()},updateDataSize:function(){var a=this.control,g=this.getBox("cols.layout"),h=this.getBox("data.layout"),d=a.rowsCount,i=a.columnsCount,c=0,f=0,b=0;while(b<i){if(a.isIgnoredX(b)){b++;continue}var e=a.getColumn(b);c+=e&&e.columnWidth||a.columnWidth;b++}while(d>0){d--;if(!a.isIgnoredY(d))f++}g.setWidth(c+50);h.css({width:c,height:f*a.columnHeight})},dataScroll:function(){var b=this.getBox("cols"),a=this.getBox("data"),c=this.getBox("rows");b.scrollLeft(a.scrollLeft());c.scrollTop(a.scrollTop());this.fire("scroll")}}});ui.olap.Types={_floatSum:function(d,c,b){var a=parseFloat(c[b]);if(!isNaN(a))d.value+=a},_getFormatCode:function(a){return a.typeConfig&&a.typeConfig.formatCode||ui.olap.Types[a.type].formatCode},progress:{tpl:"{percent} %",decimals:2,formatCode:"0.00 \\%",renderer:function(h,d,a,b,e,j){var i=b.getCellValue(e,j),g=b.getCellValue(e,b.rootRows[b.rootRows.length-1].index),c=i.renderValue||0,f=(a.typeConfig&&a.typeConfig.tpl||d.tpl).replace("{value}",h).replace("{all}",g.value).replace("{percent}",c.toFixed(a.typeConfig&&a.typeConfig.decimals||d.decimals));return['<div style="width:',c,'%;" class="ui-olap-percent-cell"></div>','<div class="ui-olap-percent-cell-value">',f,"</div>"].join("")},format:function(a,h,d,b,f,g){var c=b.rootRows[b.rootRows.length-1].index;if(g!=c){var e=b.getCellValue(f,c);a.renderValue=a.value/(e.value/100)}else a.renderValue=100;a.formatCode=ui.olap.Types._getFormatCode(d)},summary:function(c,b,d,a){ui.olap.Types[a.valueType].summary(c,b,a.typeConfig.dataIndex,a)}},"int":{formatCode:"0",renderer:function(a){a=parseInt(a);return isNaN(a)?0:a},format:function(b,c,a){b.formatCode=ui.olap.Types._getFormatCode(a)},summary:function(c,b,a){ui.olap.Types._floatSum(c,b,a)}},count:{formatCode:"0",renderer:function(a){return a},format:function(b,c,a){b.formatCode=ui.olap.Types._getFormatCode(a)},summary:function(a){a.value++}},decimal:{separator:",",decimals:1,formatCode:"0.0",renderer:function(a,c,b){var e=b.typeConfig?b.typeConfig.decimals||c.decimals:c.decimals,d=b.typeConfig?b.typeConfig.separator||c.separator:c.separator;a=parseFloat(a);if(isNaN(a))a=0;return a.toFixed(e).replace(/(\d)(?=(\d{3})+\.)/g,"$1 ").replace(".",d)},format:function(b,c,a){b.formatCode=ui.olap.Types._getFormatCode(a)},summary:function(c,b,a){ui.olap.Types._floatSum(c,b,a)}},money:{separator:",",decimals:1,suffix:"",formatCode:"#,##0.0",renderer:function(a,b,c){a=ui.olap.Types.decimal.renderer(a,b,c);return a+" "+b.suffix},format:function(b,c,a){b.formatCode=ui.olap.Types._getFormatCode(a)},summary:function(c,b,a){ui.olap.Types._floatSum(c,b,a)}}};ui.define({name:"ui.olap.exporters.Base",type:"ui.olap.exporters.Base",base:"base",data:{exportOlap:function(c){var b=this,a=b.olap,d=a.colGroups.length,e=a._cols.map(function(b,a){return a}),f=a._rows.map(function(b,a){return a});a.store.listData(e,f,null,function(){if(a.dataFields.length>1)d++;b.expandedCols=0;a.fields.find({area:"rows"},function(b){this.exportRowHeader(b,{rows:d,cols:1,width:b.width||a.columnWidth})},b);ui.each(a.rootColumns,function(a){this._exportColumn(a,this._columnSize(a),0)},b);ui.each(a.rootRows,function(a,b){this._exportRow(a,this._rowSize(a),b)},b);if(a.dataFields.length>1)b.expandedCols++;c&&c(b,a)})},exportRowHeader:function(){},exportColumn:function(){},exportRow:function(){},exportCell:function(){},_exportColumn:function(a,d,b){var c=this.olap;if(c.hideSummary&&!a.isSummary()||!c.hideSummary||a.mainColumnSummary)if(c.colsFields.length){this.exportColumn(a,d);if(a.expanded&&a.groups.length){b++;ui.each(a.groups,function(a){this._exportColumn(a,this._columnSize(a),b)},this);if(b>this.expandedCols)this.expandedCols=b}else a.hasSources()&&!a.source&&ui.each(a.sources,function(a){a.level=0;this._exportColumn(a,this._columnSize(a),0)},this)}else ui.each(a.sources,function(a){a.level=0;this.exportColumn(a,this._columnSize(a))},this)},_exportRow:function(a,e,f){var b=this.olap;if(b.hideSummary&&!a.isSummary()||!b.hideSummary||a.mainRowSummary){if((a.summary||a.field.sum)&&!a.parentGroup.expanded)return;this.exportRow(a,e,f);if(a.expanded&&a.groups.length)ui.each(a.groups,function(a,b){this._exportRow(a,this._rowSize(a),b)},this);else for(var c=0,d=b.columnsCount;c<d;c++)!b.isIgnoredX(c)&&this.exportCell(b.getCellValue(c,a.sumGroup?a.sumGroup.index:a.index),{width:b.getColumn(c).columnWidth||b.columnWidth},c==d-1)}},_columnSize:function(a){var e=this.olap,b=1,d=1,c;if(e.hideSummary&&a.isSummary())b=0;if(a.expanded&&a.groups.length&&!a.field.summary){b=0;ui.each(a.groups,function(a){b+=this._columnSize(a).cols},this)}else{d=a.level;if(a.hasSources()&&!a.source)b=a.sources.length}if(!a.groups.length)c=this.olap.getColumn(a.index).columnWidth||this.olap.columnWidth;if(!a.expanded&&a.sumGroup)c=this.olap.getColumn(a.sumGroup.index).columnWidth||this.olap.columnWidth;return{rows:d,width:c,cols:b}},_rowSize:function(a){var b=1,c=0,d=this;if(!a.expanded||a.summary)b=a.level;return{rows:a.getRowsCount(),cols:b||1}}}});ui.define({name:"ui.olap.exporters.HTML",type:"ui.olap.exporters.HTML",base:"ui.olap.exporters.Base",data:{tdStyle:"border-right:1px solid #000;border-bottom: 1px solid #000;",exportOlap:function(){var a=[];this._rc=[];this._hc=[[]];this.base(function(b){a.push('<table style="table-layout:fixed;font-family:Tahoma,tahoma;font-size: 10px;border-collapse: collapse;border-left:1px solid #000;border-top:1px solid #000;">');ui.each(b._hc,function(b){a.push("<tr>"+(b?b.join(""):"")+"</tr>")});for(var c=b.olap.colGroups.length-b.expandedCols;c>1;c--)a.push('<tr style="height:10px;"></tr>');a.push(b._rc.join(""));a.push("</table>");var d=window.open();d.document.body.innerHTML=a.join("")})},writeTD:function(d,b,c){var a=[];b=b||{};a.push('<td style="');a.push(this.tdStyle);a.push(c||"font-weight: normal;background-color:#e3e4e6;");a.push('" ');b.cols>1&&a.push('colspan="'+b.cols+'" ');b.rows>1&&a.push('rowspan="'+b.rows+'" ');a.push(">");a.push('<div style="padding:3px 6px;overflow:hidden;');if(b.width){a.push("width:");a.push(b.width-12);a.push("px;")}a.push('">');a.push(d||"Пусто");a.push("</div>");a.push("</td>");return a.join("")},exportRowHeader:function(a,b){this._hc[0].push(this.writeTD(a.header,b))},exportColumn:function(a,c){var d=this.olap.colGroups.length-a.level,b=this._hc[d];if(!b)this._hc[d]=b=[];b.push(this.writeTD(a.title,c));this.base(a,c)},exportRow:function(d,b,a){var c="text-align: left;vertical-align:top;background-color:#e3e4e6;";a>0&&this._rc.push("<tr>");this._rc.push(this.writeTD(d.title,b,c))},exportCell:function(a,d,c){var b=["text-align: right;vertical-align:bottom;"];a.summary&&b.push("font-weight:bold;");this._rc.push(this.writeTD(a.value||"0",d,b.join("")));c&&this._rc.push("</tr>")}}});ui.define({name:"ui.olap.exporters.XLSX",type:"ui.olap.exporters.XLSX",base:"ui.olap.exporters.Base",data:{borders:{bottom:"000000",right:"000000",left:"000000",top:"000000"},emptyTitle:"Пусто",exportOlap:function(){this._data=[[]];this._rd=[];this.base(function(a){window.location.href=a.getWorkBook().href()})},exportRowHeader:function(b,a){this._data[0].push({value:b.header,colSpan:a.cols,rowSpan:a.rows,width:a.width,borders:this.borders,vAlign:"center",hAlign:"center",fontSize:8,wrapText:true,bgColor:"D3D3D3"})},exportColumn:function(a,b){var d=this.olap.colGroups.length-a.level,c=this._data[d];if(!c)this._data[d]=c=[];c.push({value:this._getTitle(a.title),colSpan:b.cols,rowSpan:b.rows,borders:this.borders,vAlign:"center",hAlign:"center",fontSize:8,wrapText:true,bold:a.field?a.field.summary:false,bgColor:"D3D3D3"});this.base(a,b)},exportRow:function(b,c,d){var a=this._rd[this._rd.length-1];if(d>0||!a){a=[];this._rd.push(a)}a.push({value:this._getTitle(b.title),colSpan:c.cols,vAlign:"top",hAlign:"left",rowSpan:c.rows,borders:this.borders,bgColor:"FAFAFA",bold:b.field?b.field.summary:false,fontSize:8,wrapText:true})},exportCell:function(a,b){var c=this._rd[this._rd.length-1];c.push({value:a.renderValue||a.value,bold:a.summary,formatCode:a.formatCode||"0.00",bgColor:a.summary?"FAFAFA":null,width:b.width,borders:this.borders,fontSize:8,number:true})},getWorkBook:function(){for(var a=this.olap.colGroups.length-this.expandedCols;a>1;a--)this._data.push([]);return xlsx({creator:"John Doe",lastModifiedBy:"Meg White",worksheets:[{name:"sheet 1",data:this._data.concat(this._rd)}]})},_getTitle:function(a){return a?a.replace(/<(?:.|\n)*?>/gm,""):this.emptyTitle}}});ui.define({name:"ui.olap.plugins.QueryBuilder",type:"olap.queryBuilder",base:"base",data:{init:function(a){this.base(a);this.component.on("renderEnd",this.onRenderEnd,this);this.component.on("redraw",this.onRedraw,this);this.component.on("beforefilter",this.onBeforeFilter,this);this.component.on("layout",this.onLayout,this)},show:function(){if(this.builder){this.builder.doRender();this.builder.modal.show();this.builder.query=ui.clone(this.query||{AND:[]});this.builder.redraw()}else this.create()},toggle:function(){this.enabled=!this.enabled;this.component.filter()},create:function(e){var b=this.component,d=this,a=$('<div class="ui-modal"/>'),c=$('<div class="ui-buttons"/>'),f=this.query||{AND:[]};this.builder=ui.instance({type:"queryBuilder",query:f,left:50,top:50,right:50,bottom:50,parent:a,modal:a,autoRender:e,getField:function(a){return b.fields.findOne({dataIndex:a})},getFieldTitle:function(c){var a=b.fields.findOne({dataIndex:c});return a&&a.header?a.header:c},getOperands:function(d){var c=b.fields.findOne({dataIndex:d}),a=["EQ","NOT"];switch(c.type){case"int":a=a.concat(["LT","LTR","GT","GTR"])}return a},getFields:function(){return b.fields.map("dataIndex")},getGroups:function(c,a){return b.store.getGroups(c,a)},listeners:{renderEnd:function(){$('<div class="ui-btn"><span class="text">Принять</span></div>').click(function(){d.enabled=true;d.query=ui.clone(d.builder.query);b.filter();a.hide()}).appendTo(c);$('<div class="ui-btn"><span class="text">Отмена</span></div>').click(function(){a.hide()}).appendTo(c);c.appendTo(this.el);a.appendTo(b.el);a.click(function(b){b.target===a.get(0)&&a.hide()})}}})},onLayout:function(a){a.on("update",function(a){!this.builder&&this.create(false);this.builder.query=ui.clone(a.q);this.enabled=!!a.qe},this);a.on("get",function(a){if(this.builder){a.qe=this.enabled?1:0;a.q=ui.clone(this.builder.query)}},this);a.on("clear",function(){this.query={AND:[]};this.enabled=false;if(this.builder)this.builder.query={AND:[]}},this)},onBeforeFilter:function(d,c){if(this.enabled&&this.builder){var b=this.builder.query,a={},e=this.builder.getQueryFunction();this.query=ui.clone(b);if(e){b.AND=b.AND||[];d.fields.each(function(d){var c=d.dataIndex;ui.each(d.filter,function(d){if(!a[c]){a[c]={OR:[]};b.AND.push(a[c])}a[c].OR.push({value:d,op:"EQ",field:c})})});c.filters=this.builder.getQueryFunction();this.builder.query=this.query}}},onRedraw:function(c){var b=c.view.getBox("filter.builder-query"),a=c.view.getBox("filter.builder-on");if(this.builder&&this.builder.getQueryFunction()){b.setHtml(this.builder.getQueryString("html"));a.show()}else{b.setHtml(null);a.hide()}a[this.enabled?"removeClass":"addClass"]("disabled")},onRenderEnd:function(b){var a=b.view;a.setBox({name:"filter",items:["builder-on","builder-query",{name:"builder-link",extraCls:"ui-btn",html:'<span class="text">Показать фильтр</span>'}]});a.getBox("filter.builder-link").on("click",this.show,this);a.getBox("filter.builder-on").on("click",this.toggle,this);a.on("updateSize",this.onOlapUpdateSize,this)},onOlapUpdateSize:function(){var f=this.component,a=f.view,e=a.getBox("border"),c=a.getBox("data"),d=a.getBox("rows"),b=a.getBox("filter").outerHeight();e.css({bottom:b});c.css({bottom:b});d.css({bottom:b})}}});ui.define({name:"ui.olap.plugins.Chart",type:"olap.chart",base:"base",data:{init:function(a){this.base(a);this.component.on("renderEnd",this.onRenderEnd,this)},getSeries:function(a){var b=[];ui.each(a.data,function(d,c){b.push({data:d,name:a.rows[c]})});return b},onRenderEnd:function(a){if(a.selection)a.selection.on("selectionchange",this.onSelectionChange,this)},onSelectionChange:function(b,a){if(this.chartEl){this.chartEl.remove();delete this.chartEl}if(a){this.chartEl=$('<div style="position: absolute;right:50px;top:50px;border:1px solid #000;width:700px;height:500px;"></div>').appendTo("body");this.chartEl.highcharts({series:this.getSeries(a),xAxis:{categories:a.cols,labels:{style:{fontSize:"10px",fontFamily:"tahoma, sans-serif"}}},chart:{type:"bar"},title:{text:null},yAxis:{title:{enabled:false}},tooltip:{style:{fontSize:"10px",width:"250px",wrap:"hard"}},legend:{align:"right",verticalAlign:"middle",layout:"vertical",itemStyle:{width:250,fontSize:"12px"},borderWidth:0},exporting:{enabled:false},credits:{enabled:false}})}}}});ui.define({name:"ui.olap.plugins.StyleConditions.Combo",type:"olap.styleConditions.combo",base:"combo",data:{dataIndex:"code",displayName:"name",data:[{name:"Равно",view:"=",code:0,test:function(b,a){return b==a}},{name:"Не равно",view:"!=",code:1,test:function(b,a){return b!=a}},{name:"Больше",view:"&gt;",code:2,test:function(b,a){return b>a}},{name:"Больше или равно",view:"&gt;=",code:3,test:function(b,a){return b>=a}},{name:"Интервал",view:"&lt;&gt;",code:4,interval:true,test:function(a,b,c){return a>b&&a<c}}]}});ui.define({name:"ui.olap.plugins.StyleConditions.Editor",type:"olap.styleConditions",base:"control",data:{viewType:"olap.styleConditions.view",cls:"ui-scseditor",parent:"body",autoRender:false,init:function(a){a=a||{};a.conditions=a.conditions||[];this.base(a);this.component.on("layout",this.onLayoutReady,this);this.component.on("renderCell",this.onRenderCell,this);this.component.on("styleConditionsShow",this.show,this);this.component.on("styleConditionsHide",this.hide,this);this.component.on("styleConditionsClear",this.clearData,this)},render:function(){this.base();this.on("renderEnd",function(){this.renderConditions(this.conditions)},this);var d=this.view,c=d.getBox("body.form"),g=d.getBox("body.styles"),a=this,e=this.component.fields.find({area:"data"}),b=function(c,b){if(a.selected){a.selected.data[b.conditionKey]=c;a.selected.update()}},f=function(c,b){if(a.selected){a.selected.data.s[b.conditionKey]=c;a.selected.update()}};this.cData=ui.instance({type:"combo",label:"Источник",data:e,displayName:"header",dataIndex:"dataIndex",conditionKey:"f",parent:c,listeners:{change:b}});this.cOperation=ui.instance({type:"olap.styleConditions.combo",label:"Условие",conditionKey:"o",parent:c,listeners:{change:b}});this.fValue1=ui.instance({type:"field",label:"Первое значение",conditionKey:"v1",parent:c,listeners:{change:b}});this.fValue2=ui.instance({type:"field",label:"Второе значение",conditionKey:"v2",parent:c,listeners:{change:b}});this.fStyleColor=ui.instance({type:"field",label:"Цвет текста",conditionKey:"color",parent:g,listeners:{change:f}});this.fStyleBackground=ui.instance({type:"field",label:"Цвет фона",conditionKey:"backgroundColor",parent:g,listeners:{change:f}});this.cOperation.on("change",this.onOperationChange,this);d.getBox("tbar.add").on("click",function(){this.addCondition({f:e.length?e[0].dataIndex:null,o:0,v1:null,v2:null,s:{}},true)},this);d.getBox("tbar.close").on("click",this.hide,this)},clearData:function(){this._conditions=[];this.conditions=[];if(this.rendered){this.view.getBox("body.conditions").empty();this.setFormData({s:{}})}this.component.dataScroll.defer(1,this.component)},renderConditions:function(a){this.clearData();this.conditions=a;ui.each(a,function(a){this.addCondition(a,false,true)},this)},addCondition:function(b,c,d){var a={};if(this.rendered){a=this.view.addCondition(b);a.text.on("click",this.selectCondition.delegate(this,a));a.close.on("click",this.removeCondition.delegate(this,a));a.data=b;a.update(d)}else a.data=b;this.rendered&&c&&this.selectCondition(a);this._conditions.push(a)},removeCondition:function(a){if(this.selected===a)this.selected=null;this._conditions.remove(a);a.el.destroy();this.setFormData({s:{}});this.component.dataScroll.defer(1,this.component)},selectCondition:function(a){this.view.getBox("body.conditions").find(".active").removeClass("active");a.el.addClass("active");this.selected=a;this.setFormData(a.data);this.onOperationChange()},setFormData:function(a){this.cData.setValue(a.f,true);this.fValue1.setValue(a.v1,true);this.fValue2.setValue(a.v2,true);this.cOperation.setValue(a.o,true);this.fStyleColor.setValue(a.s.color,true);this.fStyleBackground.setValue(a.s.backgroundColor,true)},onOperationChange:function(){if(this.cOperation.value.interval)this.fValue2.show();else{this.fValue2.hide();this.fValue2.setValue(null)}},onLayoutReady:function(a){a.on("get",function(a){a.sc=[];ui.each(this._conditions,function(b){a.sc.push(b.data)})},this);a.on("update",function(a){this.selected=null;this.renderConditions(a.sc)},this);a.on("clear",this.clearData,this)},onRenderCell:function(c,g,d,h){var e=d.getColumn(h),a={},f=ui.array(ui.olap.plugins.StyleConditions.Combo.prototype.data),b=function(b){if(!a[b])a[b]=f.findOne({code:b}).test;return a[b]};ui.each(this._conditions,function(f){var d,a=f.data;if(e.field.dataIndex==a.f){d=b(a.o);if(d&&d(g.value,a.v1,a.v2)){c.css(a.s);return false}}})}}});ui.define({name:"ui.olap.plugins.StyleConditions.View",type:"olap.styleConditions.view",base:"view",data:{itemTpl:'<div class="item"/>',textTpl:'<div class="text"/>',closeTpl:'<div class="ui-close"/>',viewConfig:function(){return[{name:"tbar",items:[{name:"add",html:'<span class="text">Добавить условие</span>',cls:"ui-btn"},{name:"close",cls:"ui-close"}]},{name:"body",items:["conditions","form","styles"]}]},addCondition:function(a){var f=this.getBox("body.conditions"),c=this.control.component,b=$(this.itemTpl).appendTo(f.el),d=$(this.textTpl),e=$(this.closeTpl);d.appendTo(b);e.appendTo(b);return{el:ui.instance({type:"element",el:b}),text:ui.instance({type:"element",el:d}),close:ui.instance({type:"element",el:e}),update:function(f){var b=[],e=ui.array(ui.olap.plugins.StyleConditions.Combo.prototype.data).findOne({code:a.o});if(a.f){b.push("[");b.push(c.fields.findOne({dataIndex:a.f}).header);b.push("]")}if(e){b.push(" ");b.push(e.view)}if(a.v1&&a.v1!=""){b.push(" ");b.push(a.v1);if(a.v2&&a.v2!=""){b.push(", ");b.push(a.v2)}}d.html(b.join(""));f!==true&&c.dataScroll.defer(1,c)}}}}})